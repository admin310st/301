# Правила делегирования и арбитража

## Субагенты проекта

| Агент | Зона | Роль |
|-------|------|------|
| `api-dev` | `src/api/**` | Основной разработчик — CRUD, auth, integrations, Apply Pipeline |
| `webhook-dev` | `src/webhook/**` | Webhook Worker — приём внешних событий |
| `migration` | `schema/**` | D1 миграции и reference-схема |
| `docs` | `wiki/**` | Документация (русский язык) |
| `e2e` | браузер | Browser testing через Playwright MCP |
| `reviewer` | read-only | Code review + security audit |

## Когда делегировать субагенту

- Задача затрагивает один модуль → один субагент
- Рутинная задача (добавить поле, исправить текст) → субагент напрямую, без плана
- Задача кросс-модульная → последовательно по зависимостям

## Когда НЕ делегировать

- Архитектурное решение → лид анализирует, предлагает ADR, ждёт подтверждения пользователя
- Изменение `.claude/rules/` или `CLAUDE.md` → только с явного подтверждения пользователя
- Неясная задача → лид уточняет у пользователя, потом делегирует

## Порядок при кросс-модульных задачах

```
1. migration   → schema changes (если нужны)
2. api-dev     → бизнес-логика, endpoints, handlers
3. webhook-dev → обработка внешних событий (если затронут)
4. docs        → обновление wiki
5. e2e         → smoke test через UI (если возможно)
6. reviewer    → финальная проверка всех изменений
```

docs всегда последний перед reviewer. reviewer всегда самый последний.

## Арбитраж

- Субагент хочет изменить чужую зону → **СТОП**, вернуть спецификацию лиду
- Бизнес-логика в webhook → **ОТКЛОНИТЬ**, направить в api-dev
- Прямой SQL в docs → невозможно (docs = read-only для кода)
- api-dev хочет менять schema → **СТОП**, сначала migration агент
- Любой агент хочет менять `.claude/rules/` → **СТОП**, только с подтверждения пользователя

## Параллелизм

Фазы внутри одной задачи выполняются последовательно по зависимостям.
Независимые задачи в рамках одной фазы могут выполняться параллельно:

```
Фаза 1: migration (schema)
Фаза 2: api-dev (зависит от migration)
Фаза 3: docs + e2e (параллельно, оба зависят от api-dev)
Фаза 4: reviewer (зависит от всех)
```
