# Data Model (–ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö)

## 1. –í–≤–µ–¥–µ–Ω–∏–µ

–ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã 301.st –æ–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É—é—Ç—Å—è –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –¥–æ–º–µ–Ω–æ–≤ –∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–ª–µ—Å—Å-–ø–æ–¥—Ö–æ–¥–µ Cloudflare –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∏–∑–æ–ª—è—Ü–∏—é –∫–ª–∏–µ–Ω—Ç–æ–≤.

**üìÑ –°—Ö–µ–º–∞ –ë–î –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ñ–∞–π–ª–∞—Ö:**
- **[301.txt](./301.txt)** ‚Äî –ø–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
- **[301_d1.sql](./301_d1.sql)** ‚Äî –≥–æ—Ç–æ–≤–∞—è –∫ –¥–µ–ø–ª–æ—é –≤–µ—Ä—Å–∏—è –¥–ª—è Cloudflare D1
- **[Appendix.md](./Appendix.md)** ‚Äî –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏–∏ Projects ‚Üí Sites ‚Üí Zones ‚Üí Domains

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

* **Multi-tenant –∏–∑–æ–ª—è—Ü–∏—è:** –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–¥–µ—Ä–∂–∞—Ç `account_id` –¥–ª—è —Å—Ç—Ä–æ–≥–æ–π –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.
* **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ—ë–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è:** D1 (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ), KV (runtime-–∫—ç—à), R2 (–∞—Ä—Ö–∏–≤—ã), Queues (—Å–æ–±—ã—Ç–∏—è).
* **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ:** –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–ª—é—á–∏ –∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —à–∏—Ñ—Ä—É—é—Ç—Å—è (AES-GCM).
* **–ê—É–¥–∏—Ç –∏ –∑–∞–¥–∞—á–∏:** –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `tasks` –∏ `audit_log`.

### –£—Ä–æ–≤–Ω–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è

| –•—Ä–∞–Ω–∏–ª–∏—â–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                               | –ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö |
| --------- | -------------------------------------------------------- | -------------- |
| **D1 (SQL)**  | –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã   | users, accounts, domains, redirect_rules |
| **KV**        | –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏ –∏ –∫—ç—à –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è (runtime snapshots) | API-–∫–ª—é—á–∏, refresh-—Ç–æ–∫–µ–Ω—ã, JSON-—Å–Ω–∞–ø—à–æ—Ç—ã –ø—Ä–∞–≤–∏–ª |
| **R2**        | –û–±—ä–µ–∫—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π, –ª–æ–≥–æ–≤ –∏ –æ—Ç—á—ë—Ç–æ–≤ | backup.sql.gz, analytics.csv |
| **Queues**    | –û—á–µ—Ä–µ–¥–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤      | redirect_logs, notifications |

---

## 2. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ KV –∏ D1

### –û–±—â–∏–π –ø—Ä–∏–Ω—Ü–∏–ø

D1 –∏ KV —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –≤–∑–∞–∏–º–æ–¥–æ–ø–æ–ª–Ω—è—é—â–∏–µ —Å–ª–æ–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è:

* **D1** —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, —Å—Ç–∞—Ç—É—Å—ã –∏ –∞—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π.
* **KV** —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ JSON-–∫—ç—à –ø—Ä–∞–≤–∏–ª –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ Edge.

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–±–∞–≤–ª—è–µ—Ç API-–∫–ª—é—á –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤).
2. **API-–≤–æ—Ä–∫–µ—Ä:**
   - –®–∏—Ñ—Ä—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ (AES-GCM —Å `MASTER_SECRET`)
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ **KV** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `cred:cloudflare:UUID`)
   - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ **D1**: `kv_key`, `provider`, `status`, `created_at`
3. **Edge-–≤–æ—Ä–∫–µ—Ä –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏:**
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ KV
   - –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –∏—Ö –Ω–∞ –ª–µ—Ç—É
   - –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ D1
4. **–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª:**
   - API-–≤–æ—Ä–∫–µ—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ D1
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç snapshot –≤ KV
   - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ `audit_log`

### –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π

| –°–ª–æ–π | –†–æ–ª—å | –î–æ—Å—Ç—É–ø |
|------|------|--------|
| **D1** | –û—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã | API-–≤–æ—Ä–∫–µ—Ä (read/write), Jobs (read/write) |
| **KV** | Runtime-–∫—ç—à –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ | API-–≤–æ—Ä–∫–µ—Ä (read/write), Edge-–≤–æ—Ä–∫–µ—Ä (read-only) |

**‚ö†Ô∏è –í–∞–∂–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:**
- Edge-–≤–æ—Ä–∫–µ—Ä—ã **–ù–ï –ò–ú–ï–Æ–¢** –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞–ø–∏—Å–∏ –≤ KV
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ API-–≤–æ—Ä–∫–µ—Ä
- KV –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è –≤ runtime

---

## 3. D1 ‚Äî –†–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### 3.1 –ü—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

* D1 ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–µ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö.
* **–í—Å–µ —Ä–∞–±–æ—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã** —Å–æ–¥–µ—Ä–∂–∞—Ç `account_id` –¥–ª—è multi-tenant –∏–∑–æ–ª—è—Ü–∏–∏.
* –ò—Å–∫–ª—é—á–µ–Ω–∏—è: `audit_log` –∏ `backups` –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ **–ë–ï–ó FK** –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏.
* –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ `tasks` –∏ `audit_log`.
* –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∫—Ä—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—ã–Ω–æ—Å—è—Ç—Å—è –≤ KV –∏–ª–∏ R2.

### 3.2 –û—Å–Ω–æ–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã —Ç–∞–±–ª–∏—Ü

| –†–∞–∑–¥–µ–ª                | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                           | –¢–∞–±–ª–∏—Ü—ã                                                               |
| --------------------- | ------------------------------------ | --------------------------------------------------------------------- |
| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ —Å–µ—Å—Å–∏–∏ | –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –∞—É–¥–∏—Ç –≤—Ö–æ–¥–æ–≤           | `users`, `sessions`                                                   |
| –ê–∫–∫–∞—É–Ω—Ç—ã –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ | –ò–∑–æ–ª—è—Ü–∏—è, API-–∫–ª—é—á–∏, –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã | `accounts`, `account_keys`                                            |
| –ü—Ä–æ–µ–∫—Ç—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞   | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–æ–Ω–∞–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏      | `projects`, `sites`, `zones`, `domains`                               |
| –†–µ–¥–∏—Ä–µ–∫—Ç—ã –∏ TDS       | –ü—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∏ —à–∞–±–ª–æ–Ω—ã      | `redirect_rules`, `redirect_templates`, `tds_rules`                   |
| –í–æ—Ä–∫–µ—Ä—ã               | –î–µ–ø–ª–æ–π –∏ —à–∞–±–ª–æ–Ω—ã –≤–æ—Ä–∫–µ—Ä–æ–≤            | `workers`, `worker_templates`                                         |
| –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –∞—É–¥–∏—Ç     | –õ–æ–≥–∏ –∏ –∑–∞–¥–∞—á–∏                        | `redirect_logs`, `analytics_summary`, `tasks`, `audit_log`, `backups` |

**‚ö†Ô∏è –í–∞–∂–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:**
- –¢–∞–±–ª–∏—Ü—ã `redirect_rules` –∏ `tds_rules` —Å–≤—è–∑–∞–Ω—ã —Å **—Å–∞–π—Ç–∞–º–∏** (`site_id`)
- –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ **–≤—Å–µ–º –¥–æ–º–µ–Ω–∞–º** —Å–∞–π—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ö–∞–∂–¥–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ç–∞–∫–∂–µ –∏–º–µ–µ—Ç `account_id` –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏

### 3.3 –ò–µ—Ä–∞—Ä—Ö–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π

```
Account (–ê–∫–∫–∞—É–Ω—Ç –∫–ª–∏–µ–Ω—Ç–∞)
  ‚îî‚îÄ Project (–ü—Ä–æ–µ–∫—Ç/–ö–∞–º–ø–∞–Ω–∏—è)
       ‚îî‚îÄ Site (–°–∞–π—Ç)
            ‚îú‚îÄ Zone (–ó–æ–Ω–∞ Cloudflare) 1:1
            ‚îÇ    ‚îî‚îÄ Domain (–î–æ–º–µ–Ω—ã) 1:N
            ‚îÇ
            ‚îú‚îÄ redirect_rules (–ü—Ä–∞–≤–∏–ª–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤)
            ‚îî‚îÄ tds_rules (–ü—Ä–∞–≤–∏–ª–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞)
```

**üìñ –ü–æ–¥—Ä–æ–±–Ω–µ–µ:** —Å–º. [Appendix.md](./Appendix.md) ‚Äî –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏–∏, –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —É–¥–∞–ª–µ–Ω–∏—è.

**‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è:**
- **1 Site = 1 Zone** (—Å—Ç—Ä–æ–≥–∞—è –ø—Ä–∏–≤—è–∑–∫–∞)
- **1 Zone = N Domains** (–∑–æ–Ω–∞ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–æ–º–µ–Ω–æ–≤)
- **Domains –∏–º–µ—é—Ç —Ä–æ–ª–∏:**
  - `primary` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω —Å TDS
  - `donor` ‚Äî –¥–æ–Ω–æ—Ä—Å–∫–∏–π –¥–æ–º–µ–Ω –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤
- **Zone –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** (—Ä–∞–Ω—å—à–µ –±—ã–ª–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `zone_settings`):
  - `auto_https`, `caching_level`, `waf_mode` ‚Äî —Ç–µ–ø–µ—Ä—å –ø–æ–ª—è –≤ `zones`

### 3.4 –°–≤—è–∑–∏ —Ç–∞–±–ª–∏—Ü (ER-–¥–∏–∞–≥—Ä–∞–º–º–∞)

```mermaid
erDiagram
    users ||--o{ sessions : "1:N"
    users ||--o{ accounts : "–≤–ª–∞–¥–µ–ª–µ—Ü"
    
    accounts ||--o{ projects : "—Å–æ–¥–µ—Ä–∂–∏—Ç"
    accounts ||--o{ account_keys : "API-–∫–ª—é—á–∏"
    accounts ||--o{ workers : "–≤–æ—Ä–∫–µ—Ä—ã"
    accounts ||--o{ tasks : "–æ–ø–µ—Ä–∞—Ü–∏–∏"
    accounts ||--o{ audit_log : "–∞—É–¥–∏—Ç (–±–µ–∑ FK)"
    accounts ||--o{ backups : "—Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ (–±–µ–∑ FK)"
    
    projects ||--o{ sites : "—É–ø—Ä–∞–≤–ª—è–µ—Ç"
    
    sites ||--o| zones : "1:1 –∑–æ–Ω–∞"
    sites ||--o{ redirect_rules : "–ø—Ä–∞–≤–∏–ª–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤"
    sites ||--o{ tds_rules : "–ø—Ä–∞–≤–∏–ª–∞ TDS"
    sites ||--o{ redirect_logs : "–ª–æ–≥–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤"
    sites ||--o{ analytics_summary : "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞"
    
    zones ||--o{ domains : "1:N –¥–æ–º–µ–Ω—ã"
    
    workers ||--o| worker_templates : "–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —à–∞–±–ª–æ–Ω"
```

**‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã FK –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:**

| –°–≤—è–∑—å | ON DELETE | –ü–æ–≤–µ–¥–µ–Ω–∏–µ |
|-------|-----------|-----------|
| `users` ‚Üí `sessions` | **CASCADE** | –£–¥–∞–ª–µ–Ω–∏–µ user —É–¥–∞–ª—è–µ—Ç –≤—Å–µ —Å–µ—Å—Å–∏–∏ |
| `users` ‚Üí `accounts` | **CASCADE** | –£–¥–∞–ª–µ–Ω–∏–µ user —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã |
| `accounts` ‚Üí `projects` | **CASCADE** | –£–¥–∞–ª–µ–Ω–∏–µ account —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã |
| `projects` ‚Üí `sites` | **CASCADE** | –£–¥–∞–ª–µ–Ω–∏–µ project —É–¥–∞–ª—è–µ—Ç –≤—Å–µ —Å–∞–π—Ç—ã |
| `sites` ‚Üí `zones` | **SET NULL** | –£–¥–∞–ª–µ–Ω–∏–µ site –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –∑–æ–Ω—ã |
| `zones` ‚Üí `domains` | **CASCADE** | –£–¥–∞–ª–µ–Ω–∏–µ zone —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–æ–º–µ–Ω—ã ‚ö†Ô∏è |
| `sites` ‚Üí `domains` | **SET NULL** | –£–¥–∞–ª–µ–Ω–∏–µ site –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –¥–æ–º–µ–Ω—ã |

**üìñ –ü–æ–¥—Ä–æ–±–Ω–µ–µ –ø—Ä–æ —É–¥–∞–ª–µ–Ω–∏–µ:** —Å–º. —Ä–∞–∑–¥–µ–ª "–°—Ü–µ–Ω–∞—Ä–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è" –≤ [Appendix.md](./Appendix.md)

### 3.5 –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î

**–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü, —Å–≤—è–∑–µ–π –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:**
- **[301.txt](./301.txt)** ‚Äî —Å—Ö–µ–º–∞ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ —Ä—É—Å—Å–∫–∏–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
- **[301_d1.sql](./301_d1.sql)** ‚Äî –≥–æ—Ç–æ–≤–∞—è –∫ –¥–µ–ø–ª–æ—é –≤–µ—Ä—Å–∏—è (–±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, —Å PRAGMA)

**‚ö†Ô∏è –î–ª—è –¥–µ–ø–ª–æ—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ `301_d1.sql`!**

---

## 4. KV ‚Äî Key-Value —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

### 4.1 –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

KV –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
1. **–•—Ä–∞–Ω–µ–Ω–∏—è –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤** (API-–∫–ª—é—á–∏, —Ç–æ–∫–µ–Ω—ã)
2. **Runtime-–∫—ç—à–∞ –ø—Ä–∞–≤–∏–ª** –¥–ª—è Edge-–≤–æ—Ä–∫–µ—Ä–æ–≤ (JSON-—Å–Ω–∞–ø—à–æ—Ç—ã)
3. **Refresh-—Ç–æ–∫–µ–Ω–æ–≤** –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**‚ö†Ô∏è –í–∞–∂–Ω–æ:** KV –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç D1, –∞ –¥–æ–ø–æ–ª–Ω—è–µ—Ç –µ–≥–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ runtime-–¥–æ—Å—Ç—É–ø–∞ –±–µ–∑ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤.

### 4.2 –û—Å–Ω–æ–≤–Ω—ã–µ namespace

| Namespace      | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                         | –ü—Ä–∏–º–µ—Ä –∫–ª—é—á–∞           | TTL | –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ |
| -------------- | ---------------------------------- | ---------------------- | --- | ---------- |
| **KV_CREDENTIALS** | –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ API-–∫–ª—é—á–∏        | `cred:cloudflare:UUID` | ‚Äî | ‚úÖ AES-GCM |
| **KV_RULES**       | JSON-—Å–Ω–∞–ø—à–æ—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤ | `rules:site:123`    | ‚Äî | ‚ùå |
| **KV_TDS**         | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ | `tds:site:abc123` | ‚Äî | ‚ùå |
| **KV_SESSIONS**    | Refresh-—Ç–æ–∫–µ–Ω—ã –∏ OAuth-—Å–æ—Å—Ç–æ—è–Ω–∏—è | `refresh:sessionId` | 7 –¥–Ω–µ–π | ‚ùå |

**‚ö†Ô∏è –í–∞–∂–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤–æ—Ä–∫–µ—Ä–æ–≤:**
- –ö–ª—é—á–∏ –≤ `KV_CREDENTIALS` **–í–°–ï–ì–î–ê –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã** ‚Üí –Ω—É–∂–Ω–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- –°–Ω–∞–ø—à–æ—Ç—ã –≤ `KV_RULES` –∏ `KV_TDS` **–ù–ï —à–∏—Ñ—Ä—É—é—Ç—Å—è** ‚Üí –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
- Edge-–≤–æ—Ä–∫–µ—Ä –∏–º–µ–µ—Ç **read-only** –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º KV

### 4.3 –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ TTL

* **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã —à–∏—Ñ—Ä—É—é—Ç—Å—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `MASTER_SECRET` (Workers Secret).
* **TTL:** –ó–∞–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä `expirationTtl` (—Å–µ–∫—É–Ω–¥—ã).
* **–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:**
  - **API-–≤–æ—Ä–∫–µ—Ä:** read + write
  - **Edge-–≤–æ—Ä–∫–µ—Ä:** read-only
  - **Jobs-–≤–æ—Ä–∫–µ—Ä:** read + write (–¥–ª—è cleanup)
* **–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞:** –¢–æ–ª—å–∫–æ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –≤–æ—Ä–∫–µ—Ä–∞, –Ω–∏–∫–æ–≥–¥–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ.

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Edge-–≤–æ—Ä–∫–µ—Ä–µ:**
```javascript
// –ü–æ–ª—É—á–∏—Ç—å —Å–Ω–∞–ø—à–æ—Ç –ø—Ä–∞–≤–∏–ª –¥–ª—è —Å–∞–π—Ç–∞
const rulesSnapshot = await env.KV_RULES.get(`rules:site:${siteId}`, 'json');
if (rulesSnapshot) {
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞–ø—Ä—è–º—É—é (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏)
    return applyRedirectRules(request, rulesSnapshot);
}
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ API-–≤–æ—Ä–∫–µ—Ä–µ:**
```javascript
// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π API-–∫–ª—é—á
const encrypted = await encryptAES(apiKey, env.MASTER_SECRET);
const kvKey = `cred:cloudflare:${crypto.randomUUID()}`;
await env.KV_CREDENTIALS.put(kvKey, encrypted);

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ D1
await env.DB301.prepare(
    "INSERT INTO account_keys (account_id, provider, kv_key) VALUES (?, ?, ?)"
).bind(accountId, 'cloudflare', kvKey).run();
```

---

## 5. R2 ‚Äî Object Storage

### 5.1 –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

R2 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è:
- –†–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π D1 (SQL dumps)
- –†–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π KV (JSON exports)
- –õ–æ–≥–æ–≤ –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á—ë—Ç–æ–≤

**‚ö†Ô∏è –í–∞–∂–Ω–æ:** R2 –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ runtime ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.

### 5.2 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

```
r2://301st-backups/
 ‚îú‚îÄ d1/
 ‚îÇ   ‚îú‚îÄ 2025-01-15/backup.sql.gz
 ‚îÇ   ‚îú‚îÄ 2025-01-16/backup.sql.gz
 ‚îÇ   ‚îî‚îÄ 2025-01-17/backup.sql.gz
 ‚îÇ
 ‚îú‚îÄ kv/
 ‚îÇ   ‚îú‚îÄ 2025-01-15/rules.json.gz
 ‚îÇ   ‚îî‚îÄ 2025-01-16/credentials.json.gz
 ‚îÇ
 ‚îî‚îÄ analytics/
     ‚îú‚îÄ 2025-01-15/report.csv
     ‚îî‚îÄ 2025-01-16/report.csv
```

### 5.3 –ü–æ–ª–∏—Ç–∏–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

* **Retention:** 30 –¥–Ω–µ–π –¥–ª—è –∞—Ä—Ö–∏–≤–æ–≤, 90 –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
* **Cleanup:** Cron-–≤–æ—Ä–∫–µ—Ä (`jobs.301.st`) –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —É–¥–∞–ª—è–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ñ–∞–π–ª—ã.
* **Audit:** –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `backups` –≤ D1.

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏ –≤ `backups`:**
```sql
INSERT INTO backups (account_id, backup_type, r2_path, size_mb)
VALUES (123, 'full', 'd1/2025-01-17/backup.sql.gz', 15.3);
```

---

## 6. Queues ‚Äî –û—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

### 6.1 –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–û—á–µ—Ä–µ–¥–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –ø–µ—Ä–µ–¥–∞—á—É —Å–æ–±—ã—Ç–∏–π** –º–µ–∂–¥—É –≤–æ—Ä–∫–µ—Ä–∞–º–∏:
- Edge ‚Üí Jobs (–ª–æ–≥–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤)
- API ‚Üí Jobs (–∑–∞–¥–∞—á–∏ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É)
- Jobs ‚Üí Notifications (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

**‚ö†Ô∏è –í–∞–∂–Ω–æ:** –û—á–µ—Ä–µ–¥–∏ —Å–Ω–∏–∂–∞—é—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ Edge-–≤–æ—Ä–∫–µ—Ä—ã –∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ.

### 6.2 –û—Å–Ω–æ–≤–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏

| –û—á–µ—Ä–µ–¥—å             | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                      | –ò—Å—Ç–æ—á–Ω–∏–∫ | –û–±—Ä–∞–±–æ—Ç—á–∏–∫ | –ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è                  |
| ------------------- | ------------------------------- | -------- | ---------- | --------------------------------- |
| **QUEUE_LOGS**          | –õ–æ–≥–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤ –æ—Ç Edge     | Edge     | Jobs       | `{ site_id, url, ip, country, ts }` |
| **QUEUE_ANALYTICS**     | –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏        | Jobs     | Jobs       | `{ account_id, date, stats }`     |
| **QUEUE_NOTIFICATIONS** | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º   | API/Jobs | Webhook    | `{ user_id, message, channel }`   |
| **QUEUE_ERRORS**        | –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Ä–µ—Ç—Ä–∞–∏   | Any      | Jobs       | `{ task_id, error, retry_after }` |

### 6.3 –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã

* **–§–æ—Ä–º–∞—Ç:** JSON-—Å–æ–æ–±—â–µ–Ω–∏—è.
* **–ò–∑–æ–ª—è—Ü–∏—è:** –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞—Ç `account_id` –¥–ª—è –º—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç–∏.
* **–û–±—Ä–∞–±–æ—Ç–∫–∞:** Jobs-–≤–æ—Ä–∫–µ—Ä —Å–ª—É—à–∞–µ—Ç –æ—á–µ—Ä–µ–¥–∏ –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ D1.
* **–†–µ—Ç—Ä–∞–∏:** –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ `QUEUE_ERRORS` —Å `retry_after`.

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Edge-–≤–æ—Ä–∫–µ—Ä–µ:**
```javascript
// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥ –≤ –æ—á–µ—Ä–µ–¥—å (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
await env.QUEUE_LOGS.send({
    site_id: 123,
    source_url: request.url,
    target_url: redirectUrl,
    ip: request.headers.get('CF-Connecting-IP'),
    country: request.cf?.country,
    timestamp: Date.now()
});

// –°—Ä–∞–∑—É –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
return Response.redirect(redirectUrl, 301);
```

**‚ö†Ô∏è –í–∞–∂–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
- Edge-–≤–æ—Ä–∫–µ—Ä **–ù–ï –ñ–î–Å–¢** –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏
- –õ–æ–≥–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
- –ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ª–æ–≥–∏ —Ç–µ—Ä—è—é—Ç—Å—è (–¥–æ–ø—É—Å—Ç–∏–º–æ –¥–ª—è MVP)

---

## 7. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –¥–∞–Ω–Ω—ã—Ö

### 7.1 –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞

1. **–§—Ä–æ–Ω—Ç–µ–Ω–¥:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–∞–≤–∏–ª–æ –≤ UI.
2. **API-–≤–æ—Ä–∫–µ—Ä:**
   - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ
   - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ D1: `INSERT INTO redirect_rules ...`
   - –°–æ–∑–¥–∞—ë—Ç task: `INSERT INTO tasks (task_type='rule_created') ...`
   - –§–æ—Ä–º–∏—Ä—É–µ—Ç JSON-snapshot –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª —Å–∞–π—Ç–∞
   - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç snapshot –≤ KV: `KV_RULES.put('rules:site:123', ...)`
   - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç audit: `INSERT INTO audit_log ...`
3. **Edge-–≤–æ—Ä–∫–µ—Ä:** –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ —á–∏—Ç–∞–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π snapshot –∏–∑ KV.

### 7.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞

1. **Edge-–≤–æ—Ä–∫–µ—Ä:** –ü–æ–ª—É—á–∞–µ—Ç HTTP-–∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ–º–µ–Ω.
2. –ò–∑–≤–ª–µ–∫–∞–µ—Ç `site_id` –ø–æ –¥–æ–º–µ–Ω—É –∏–∑ KV –∏–ª–∏ D1.
3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç snapshot –ø—Ä–∞–≤–∏–ª: `KV_RULES.get('rules:site:${siteId}')`.
4. –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ (geo, device, UTM-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã).
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (301/302).
6. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–≥ –≤ –æ—á–µ—Ä–µ–¥—å: `QUEUE_LOGS.send(...)` (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ).

### 7.3 –ê–≥—Ä–µ–≥–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

1. **Jobs-–≤–æ—Ä–∫–µ—Ä:** –°–ª—É—à–∞–µ—Ç `QUEUE_LOGS`.
2. –ë–∞—Ç—á–∏—Ç –ª–æ–≥–∏ –ø–æ 1000 –∑–∞–ø–∏—Å–µ–π.
3. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ D1: `INSERT INTO redirect_logs ...`.
4. –ï–∂–µ–¥–Ω–µ–≤–Ω–æ (Cron) –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ:
   ```sql
   INSERT INTO analytics_summary (site_id, date, redirects_count, ...)
   SELECT site_id, DATE(created_at), COUNT(*), ...
   FROM redirect_logs
   WHERE DATE(created_at) = '2025-01-17'
   GROUP BY site_id;
   ```
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á—ë—Ç –≤ R2 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).

### 7.4 –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **Jobs-–≤–æ—Ä–∫–µ—Ä (Cron, 03:00 UTC):**
   - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç D1: `wrangler d1 export DB --output=backup.sql`
   - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç KV: `KV_CREDENTIALS.list() ‚Üí JSON`
   - –°–∂–∏–º–∞–µ—Ç: `gzip backup.sql`
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤ R2: `env.R2_BACKUPS.put('d1/2025-01-17/backup.sql.gz', ...)`
3. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: `INSERT INTO backups ...`
4. –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (>30 –¥–Ω–µ–π).

---

## 8. –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –Ω—é–∞–Ω—Å—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### 8.1 –î–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

**‚úÖ DO:**
- –í—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ `account_id` –≤ API-–∑–∞–ø—Ä–æ—Å–∞—Ö (–±–µ—Ä—ë—Ç—Å—è –∏–∑ JWT)
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `site_id` –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –ø—Ä–∞–≤–∏–ª, –∞ –Ω–µ `zone_id` –∏–ª–∏ `domain_id`
- –ü–æ–º–Ω–∏—Ç–µ: **1 Site = 1 Zone = N Domains**
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ `site_id`, –ø—Ä–∞–≤–∏–ª–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –∫–æ –≤—Å–µ–º –¥–æ–º–µ–Ω–∞–º
- –î–æ–º–µ–Ω—ã –∏–º–µ—é—Ç —Ä–æ–ª–∏: `primary` (–æ—Å–Ω–æ–≤–Ω–æ–π) –∏ `donor` (–¥–ª—è —Ä–µ–∫–ª–∞–º—ã)

**‚ùå DON'T:**
- –ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–æ–º–µ–Ω–∞ (–Ω–µ—Ç —Ç–∞–∫–æ–π —Å—É—â–Ω–æ—Å—Ç–∏)
- –ù–µ –ø—ã—Ç–∞–π—Ç–µ—Å—å –ø—Ä–∏–≤—è–∑–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–æ–Ω –∫ –æ–¥–Ω–æ–º—É —Å–∞–π—Ç—É (—Å–≤—è–∑—å 1:1)
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `zone_settings` (—Ç–∞–±–ª–∏—Ü–∞ –±–æ–ª—å—à–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø–æ–ª—è –≤ `zones`)

### 8.2 –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤–æ—Ä–∫–µ—Ä–æ–≤

**‚úÖ DO (Edge-–≤–æ—Ä–∫–µ—Ä):**
- –ß–∏—Ç–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ KV, –∞ –Ω–µ –∏–∑ D1 (–±—ã—Å—Ç—Ä–µ–µ)
- –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –ª–æ–≥–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (`QUEUE_LOGS.send()`)
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `request.cf?.country` –¥–ª—è –≥–µ–æ—Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥–∞
- –ö—ç—à–∏—Ä—É–π—Ç–µ —Å–Ω–∞–ø—à–æ—Ç—ã –ø—Ä–∞–≤–∏–ª –≤ –ø–∞–º—è—Ç–∏ –≤–æ—Ä–∫–µ—Ä–∞ (–º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏)

**‚úÖ DO (API-–≤–æ—Ä–∫–µ—Ä):**
- –í—Å–µ–≥–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ D1 –∏ KV –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª
- –®–∏—Ñ—Ä—É–π—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –≤ KV
- –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ `audit_log`
- –°–æ–∑–¥–∞–≤–∞–π—Ç–µ `task` –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

**‚ùå DON'T:**
- –ù–µ –ø—ã—Ç–∞–π—Ç–µ—Å—å –ø–∏—Å–∞—Ç—å –≤ KV –∏–∑ Edge-–≤–æ—Ä–∫–µ—Ä–∞ (–Ω–µ—Ç –ø—Ä–∞–≤)
- –ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ API-–∫–ª—é—á–∏ –≤ KV
- –ù–µ –¥–µ–ª–∞–π—Ç–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –∏–∑ Edge-–≤–æ—Ä–∫–µ—Ä–∞ (–º–µ–¥–ª–µ–Ω–Ω–æ)
- –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –ø—Ä–æ `account_id` —Ñ–∏–ª—å—Ç—Ä—ã (multi-tenant!)

### 8.3 –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ Jobs-–≤–æ—Ä–∫–µ—Ä–∞

**‚úÖ DO:**
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—á–µ—Ä–µ–¥–∏ –±–∞—Ç—á–∞–º–∏ (1000 —Å–æ–æ–±—â–µ–Ω–∏–π)
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ transactions –¥–ª—è –±–∞—Ç—á–µ–≤—ã—Ö INSERT
- –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ –≤ `QUEUE_ERRORS` —Å retry
- –†–µ–≥—É–ª—è—Ä–Ω–æ –æ—á–∏—â–∞–π—Ç–µ —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ (>30 –¥–Ω–µ–π)

**‚ùå DON'T:**
- –ù–µ –±–ª–æ–∫–∏—Ä—É–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—á–µ—Ä–µ–¥–∏ –¥–æ–ª–≥–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –ø—Ä–æ –ª–∏–º–∏—Ç—ã D1 (100k rows/batch)

---

## 9. –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: "–ü—Ä–∞–≤–∏–ª–æ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –¥–æ–º–µ–Ω—É"

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–∞–≤–∏–ª–æ —Å–æ–∑–¥–∞–Ω–æ —Å `site_id`, –Ω–æ –¥–æ–º–µ–Ω –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —ç—Ç–æ–º—É —Å–∞–π—Ç—É.

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É –¥–æ–º–µ–Ω–∞
SELECT site_id FROM domains WHERE domain_name = 'example.com';

-- –ü—Ä–∏–≤—è–∑–∞—Ç—å –¥–æ–º–µ–Ω –∫ —Å–∞–π—Ç—É
UPDATE domains SET site_id = 123 WHERE domain_name = 'example.com';
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: "KV –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç null –¥–ª—è –ø—Ä–∞–≤–∏–ª"

**–ü—Ä–∏—á–∏–Ω–∞:** Snapshot –Ω–µ —Å–æ–∑–¥–∞–Ω –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–ª.

**–†–µ—à–µ–Ω–∏–µ (–≤ API-–≤–æ—Ä–∫–µ—Ä–µ):**
```javascript
// –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è snapshot
const rules = await env.DB301
    .prepare("SELECT * FROM redirect_rules WHERE site_id = ? AND is_active = 1")
    .bind(siteId).all();

await env.KV_RULES.put(`rules:site:${siteId}`, JSON.stringify(rules.results));
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: "Foreign Key constraint failed –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏"

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—ã—Ç–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é —Å—É—â–Ω–æ—Å—Ç—å, —É –∫–æ—Ç–æ—Ä–æ–π –µ—Å—Ç—å –∑–∞–≤–∏—Å–∏–º—ã–µ –¥–æ—á–µ—Ä–Ω–∏–µ.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ON DELETE –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤ —Å—Ö–µ–º–µ:
- `CASCADE` ‚Äî –¥–æ—á–µ—Ä–Ω–∏–µ —É–¥–∞–ª—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- `SET NULL` ‚Äî –¥–æ—á–µ—Ä–Ω–∏–µ –æ—Å–≤–æ–±–æ–¥—è—Ç—Å—è
- –ë–µ–∑ –¥–µ–π—Å—Ç–≤–∏—è ‚Äî –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –¥–æ—á–µ—Ä–Ω–∏–µ –≤—Ä—É—á–Ω—É—é

**–ü—Ä–∏–º–µ—Ä:**
```sql
-- –£–¥–∞–ª–∏—Ç—å –∑–æ–Ω—É ‚Üí —É–¥–∞–ª—è—Ç—Å—è –≤—Å–µ –¥–æ–º–µ–Ω—ã (CASCADE)
DELETE FROM zones WHERE id = 20;

-- –£–¥–∞–ª–∏—Ç—å —Å–∞–π—Ç ‚Üí –∑–æ–Ω—ã –æ—Å–≤–æ–±–æ–¥—è—Ç—Å—è (SET NULL)
DELETE FROM sites WHERE id = 10;
```





