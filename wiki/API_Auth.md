# API ‚Äî –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –°–µ—Å—Å–∏–∏

---
# CORS / Origin Policy

API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –∏ –≤–Ω–µ—à–Ω–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.
–í–æ –≤—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏:

https://api.301.st

https://301.st

https://301st.pages.dev

http://localhost:8787

http://localhost:3000

–í production –≤–∫–ª—é—á–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–∞—è –ø–æ–ª–∏—Ç–∏–∫ Access-Control-Allow-Origin —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–º–µ–Ω–æ–≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.

## –ë–∞–∑–æ–≤—ã–π URL

```
https://api.301.st/auth
```
---

# –†–æ–ª–∏ –∏ —Ç–∏–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å)

| **user_type** | **account_role** | **–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ** | **–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** |
|---------------|------------------|--------------------|-----------------------|
| `client`      | `owner`          | `client:owner`     | **–°–æ–∑–¥–∞—Ç–µ–ª—å –∞–∫–∫–∞—É–Ω—Ç–∞** ‚Äî –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–≤–æ–µ–º—É –∞–∫–∫–∞—É–Ω—Ç—É |
| `client`      | `editor`         | `client:editor`    | **–ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä** ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ TDS, –¥–æ–º–µ–Ω–æ–≤, —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤ |
| `client`      | `viewer`         | `client:viewer`    | **–ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å** ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä |
| `client`      | `none`           | `client:none`      | **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –≤—Ö–æ–¥ –±–µ–∑ –∞–∫–∫–∞—É–Ω—Ç–æ–≤** ‚Äî –≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø (–∞–Ω–æ–Ω–∏–º–Ω—ã–π) |
| `admin`       | `none`           | `admin:none`       | **–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É** ‚Äî –¥–æ—Å—Ç—É–ø –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π |
| `admin`       | `viewer`         | `admin:viewer`     | **–ì–ª–æ–±–∞–ª—å–Ω—ã–π –∞–¥–º–∏–Ω —Å–º–æ—Ç—Ä–∏—Ç –∞–∫–∫–∞—É–Ω—Ç –∫–ª–∏–µ–Ω—Ç–∞** ‚Äî —á—Ç–µ–Ω–∏–µ –ª—é–±—ã—Ö –¥–∞–Ω–Ω—ã—Ö |

---

# 1. –û—Å–Ω–æ–≤—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```mermaid
flowchart LR
  UI -->|start| Auth
  Auth --> TokenFlow
  TokenFlow --> UI
```

## 1.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ 301.st

* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–π **Access Token (JWT)**
* –î–æ–ª–≥–æ–∂–∏–≤—É—â–∏–π **Refresh Cookie** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—Ö–æ–¥–∞
* –î–µ–π—Å—Ç–≤–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ **OmniFlow**
* Login —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é (password-login –∏–ª–∏ Telegram mini-app)

## 1.2 Turnstile: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ UI

Turnstile –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±–æ—Ç–æ–≤:

* –û–±—è–∑–∞—Ç–µ–ª–µ–Ω –ø—Ä–∏ **register**
* –û–±—è–∑–∞—Ç–µ–ª–µ–Ω –ø—Ä–∏ **password-login** (email/phone)
* –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ login —á–µ—Ä–µ–∑ Telegram mini-app

UI –æ–±—è–∑–∞–Ω:

* –∑–∞–≥—Ä—É–∑–∏—Ç—å Turnstile widget
* –ø–æ–ª—É—á–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ç–æ–∫–µ–Ω
* –ø–µ—Ä–µ–¥–∞—Ç—å –µ–≥–æ –≤ API: `turnstile_token`

## 1.3 Access Token –∏ Refresh Cookie

* **Access Token** –∂–∏–≤—ë—Ç ~15 –º–∏–Ω
* –•—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –ù–ï –≤ localStorage
* **Refresh Cookie** –≤—ã–¥–∞—ë—Ç—Å—è HTTP-only cookie
* UI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É
* –ü—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ Access Token UI –≤—ã–∑—ã–≤–∞–µ—Ç `/auth/refresh`

## 1.4 OmniFlow

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è:

* —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (email confirm, phone OTP)
* –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞

–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è login.

## 1.5 –ö–∞–Ω–∞–ª—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è:

* email (register + password-login)
* phone (register + password-login)
* Telegram mini-app (initData)
* Google OAuth
* Github OAuth

|** –°—Ü–µ–Ω–∞—Ä–∏–π**                         |** –ü–æ–≤–µ–¥–µ–Ω–∏–µ**                              |
|--------------------------------------|--------------------------------------------|
| User –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç + `register`      | ‚úÖ –°–æ–∑–¥–∞—ë–º user + account                  |
| User –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç + `login`/`reset` | ‚ùå `user_not_found`                        |
| User —Å—É—â–µ—Å—Ç–≤—É–µ—Ç + `owner`            | ‚ùå `user_already_registered`               |
| User —Å—É—â–µ—Å—Ç–≤—É–µ—Ç + `invited only`     | ‚úÖ –°–æ–∑–¥–∞—ë–º owner account                   |

---

# 2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (Sign‚ÄëUp)

```mermaid
flowchart LR
  UI -->|register| AuthStart[/POST \/auth\/register/]
  AuthStart --> OmniToken[[omni-token]]
  OmniToken --> UserAction
  UserAction -->|verify| AuthFinish[/POST \/auth\/verify/]
  AuthFinish --> UI
```

## 2.1 POST /auth/register ‚Äî –°—Ç–∞—Ä—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ó–∞–ø—É—Å–∫–∞–µ—Ç OmniFlow —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞–Ω–∞–ª–∞ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç:

* email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (–ø–∏—Å—å–º–æ)
* phone OTP (–∫–æ–¥ —á–µ—Ä–µ–∑ SMS/–º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä)
* Telegram mini-app (—á–µ—Ä–µ–∑ initData)

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**

```
Content-Type: application/json
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**

| –ü–æ–ª–µ | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|-------------|----------|
| `email` | string | –¥–∞ | Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `password` | string | –¥–∞ | –ü–∞—Ä–æ–ª—å (–º–∏–Ω. 8 —Å–∏–º–≤–æ–ª–æ–≤, A-Z, a-z, 0-9) |
| `turnstile_token` | string | –¥–∞ | –¢–æ–∫–µ–Ω Cloudflare Turnstile |

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```bash
curl -X POST https://api.301.st/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "SecurePass123!",
    "turnstile_token": "CLIENT_TURNSTILE_TOKEN"
  }'
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "status": "pending",
  "mode": "register",
  "channel": "email",
  "token": "qtAvvHBGxI5oKdTAuPb5y"
}
```

**–û—à–∏–±–∫–∏:**

| –ö–æ–¥ | HTTP | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|------|----------|
| `email_required` | 400 | –ù–µ –ø–µ—Ä–µ–¥–∞–Ω email |
| `password_too_weak` | 400 | –ü–∞—Ä–æ–ª—å –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º |
| `user_already_registered` | 400 | Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω |
| `turnstile_failed` | 403 | –ù–µ –ø—Ä–æ–π–¥–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ Turnstile |

---

## 2.2 –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–∏—Å—å–º–æ —Å–æ —Å—Å—ã–ª–∫–æ–π –≤–∏–¥–∞:

```
https://301.st/auth/verify?token=qtAvvHBGxI5oKdTAuPb5y
```

**–í–∞–∂–Ω–æ:** –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ **–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏**.

–ö—Ä–∞—Ç–∫–∏–π —Ñ–ª–æ—É –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç —Å—Å—ã–ª–∫—É ‚Üí UI –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è.
2. UI –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ URL.
3. UI –≤—ã–∑—ã–≤–∞–µ—Ç API: `POST /auth/verify` —Å body `{"token": "..."}`.
4. `/auth/verify` –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é:
   * —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å `password_hash`;
   * —Å–æ–∑–¥–∞—ë—Ç –∞–∫–∫–∞—É–Ω—Ç –∏ membership (role: owner);
   * —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Ä–≤–µ—Ä–Ω—É—é session;
   * —Å—Ç–∞–≤–∏—Ç refresh-cookie;
   * –≤—ã–¥–∞—ë—Ç `access_token`.
5. UI –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç access_token (—Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏).
6. UI –≤—ã–ø–æ–ª–Ω—è–µ—Ç redirect –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç.

---

## 2.3 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É (OTP)

UI –ø–æ—Å–ª–µ `/auth/register` –ø–æ–ª—É—á–∞–µ—Ç:

```json
{
  "status": "code_required",
  "channel": "phone",
  "token": "omni_otp_abc123"
}
```

–ù–∞ UI –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ñ–æ—Ä–º–∞ –≤–≤–æ–¥–∞ –∫–æ–¥–∞.
–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `POST /auth/verify`:

```bash
curl -X POST https://api.301.st/auth/verify \
  -H "Content-Type: application/json" \
  -d '{
    "token": "omni_otp_abc123",
    "code": "123456"
  }'
```

---

## 2.4 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram Mini‚ÄëApp

Telegram –ø–µ—Ä–µ–¥–∞–µ—Ç **initData** –≤–Ω—É—Ç—Ä–∏ WebApp.

UI –≤—ã–∑—ã–≤–∞–µ—Ç:

```bash
curl -X POST https://api.301.st/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "tg_init": {
      "user": { "id": 123456789 },
      "auth_date": 1699999999,
      "hash": "..."
    }
  }'
```

–û—Ç–≤–µ—Ç:

```json
{
  "status": "auto",
  "mode": "register",
  "channel": "telegram"
}
```

–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Ç–æ–≥–æ –∂–µ –∑–∞–ø—Ä–æ—Å–∞.

---

## 2.5 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Google OAuth

```mermaid
flowchart LR
  UI -->|start + redirect_host| GStart[/GET \/auth\/oauth\/google\/start/]
  GStart --> Google[Google OAuth Screen]
  Google -->|redirect| GCallback[/GET \/auth\/oauth\/google\/callback/]
  GCallback --> VerifyUser[[–°–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]]
  VerifyUser --> Login[[access_token + refresh_cookie]]
  Login -->|redirect to redirect_host| UI
```

### –û–ø–∏—Å–∞–Ω–∏–µ

–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Google OAuth ‚Äî –±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–± —Å–æ–∑–¥–∞–Ω–∏—è —É—á—ë—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏.
Google –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å email, –ø–æ—ç—Ç–æ–º—É:

* **–Ω–µ—Ç Turnstile**
* **–Ω–µ—Ç –ø–∏—Å–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è**
* **–Ω–µ—Ç OTP**
* **–Ω–µ—Ç OmniFlow**

### –®–∞–≥ 1 ‚Äî –°—Ç–∞—Ä—Ç OAuth

**–ú–µ—Ç–æ–¥:** `GET /auth/oauth/google/start`

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|-------------|----------|
| `redirect_host` | string | –Ω–µ—Ç | –•–æ—Å—Ç –¥–ª—è redirect –ø–æ—Å–ª–µ OAuth (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `301.st`) |

**–ü—Ä–∏–º–µ—Ä:**

```
https://api.301.st/auth/oauth/google/start?redirect_host=app.301.st
```

–°–µ—Ä–≤–µ—Ä:

1. –ø–æ–ª—É—á–∞–µ—Ç –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç `redirect_host` –ø–æ whitelist
2. —Å–æ–∑–¥–∞—ë—Ç `state` (CSRF protection)
3. –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PKCE (code_verifier + code_challenge)
4. —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç verifier + redirect_host –≤ KV (TTL 5 –º–∏–Ω—É—Ç)
5. –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Google OAuth

### –®–∞–≥ 2 ‚Äî Callback

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Google –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –±—Ä–∞—É–∑–µ—Ä:

```
GET /auth/oauth/google/callback?code=...&state=...
```

–°–µ—Ä–≤–µ—Ä:

1. –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `state` (CSRF)
2. –∏–∑–≤–ª–µ–∫–∞–µ—Ç PKCE verifier –∏ redirect_host –∏–∑ KV
3. –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç `code ‚Üí id_token` —Å code_verifier
4. **–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç id_token —á–µ—Ä–µ–∑ Google JWKS**
5. –∏–∑–≤–ª–µ–∫–∞–µ—Ç email –∏ google_sub
6. –∏—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email –ò–õ–ò oauth_id
7. –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
8. —Å–æ–∑–¥–∞—ë—Ç –∞–∫–∫–∞—É–Ω—Ç –∏ membership (owner)
9. —Å–æ–∑–¥–∞—ë—Ç refresh-cookie
10. –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç access_token —Å fingerprint (IP + UA)
11. —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `https://{redirect_host}/auth/success?token=...`

### Whitelist —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö —Ö–æ—Å—Ç–æ–≤

–§–∏–Ω–∞–ª—å–Ω—ã–π redirect –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Ö–æ—Å—Ç—ã.
**–ò–∑–º–µ–Ω–µ–Ω–∏–µ whitelist —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–¥–µ–ø–ª–æ—è.**

| –•–æ—Å—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `app.301.st` | Production SaaS |
| `dev.301.st` | Development/Staging |
| `301.st` | Landing (fallback) |
| `localhost:5173` | Local dev (Vite) |
| `localhost:3000` | Local dev |

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ UI

```javascript
// –ò–Ω–∏—Ü–∏–∞—Ü–∏—è OAuth —Å –ø–µ—Ä–µ–¥–∞—á–µ–π —Ç–µ–∫—É—â–µ–≥–æ —Ö–æ—Å—Ç–∞
function startGoogleOAuth() {
  const host = window.location.host; // app.301.st | dev.301.st | localhost:5173
  const url = `https://api.301.st/auth/oauth/google/start?redirect_host=${encodeURIComponent(host)}`;
  window.location.href = url;
}
```

1. UI –≤—ã–∑—ã–≤–∞–µ—Ç `startGoogleOAuth()` –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google"
2. –ü–µ—Ä–µ–¥–∞—ë—Ç —Ç–µ–∫—É—â–∏–π `host` –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ `redirect_host`
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –≤ Google
4. Google —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ callback ‚Üí —Å–µ—Ä–≤–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
5. –ë—Ä–∞—É–∑–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç redirect –Ω–∞ `https://{—Ç–æ—Ç –∂–µ host}/auth/success?token=JWT`
6. UI –∏–∑–≤–ª–µ–∫–∞–µ—Ç `token` –∏–∑ URL
7. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –≤ –ø–∞–º—è—Ç–∏
8. –î–µ–ª–∞–µ—Ç redirect –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç

---

## 2.6 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ GitHub OAuth

```mermaid
flowchart LR
  UI -->|start + redirect_host| GHStart[/GET \/auth\/oauth\/github\/start/]
  GHStart --> GitHub[GitHub OAuth Screen]
  GitHub -->|redirect| GHCallback[/GET \/auth\/oauth\/github\/callback/]
  GHCallback --> VerifyUser[[–°–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]]
  VerifyUser --> Login[[access_token + refresh_cookie]]
  Login -->|redirect to redirect_host| UI
```

### –û–ø–∏—Å–∞–Ω–∏–µ

–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ GitHub OAuth —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ Google.

**–í–∞–∂–Ω–æ:** GitHub –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç PKCE –¥–ª—è OAuth Apps ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ state –¥–ª—è CSRF protection.

### –®–∞–≥ 1 ‚Äî –°—Ç–∞—Ä—Ç OAuth

**–ú–µ—Ç–æ–¥:** `GET /auth/oauth/github/start`

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|-------------|----------|
| `redirect_host` | string | –Ω–µ—Ç | –•–æ—Å—Ç –¥–ª—è redirect –ø–æ—Å–ª–µ OAuth (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `301.st`) |

**–ü—Ä–∏–º–µ—Ä:**

```
https://api.301.st/auth/oauth/github/start?redirect_host=dev.301.st
```

–°–µ—Ä–≤–µ—Ä:

1. –ø–æ–ª—É—á–∞–µ—Ç –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç `redirect_host` –ø–æ whitelist
2. —Å–æ–∑–¥–∞—ë—Ç `state` (CSRF protection)
3. —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç state + redirect_host –≤ KV (TTL 5 –º–∏–Ω—É—Ç)
4. –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ GitHub OAuth (scope: `read:user user:email`)

### –®–∞–≥ 2 ‚Äî Callback

```
GET /auth/oauth/github/callback?code=...&state=...
```

–°–µ—Ä–≤–µ—Ä:

1. –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `state`
2. –∏–∑–≤–ª–µ–∫–∞–µ—Ç redirect_host –∏–∑ KV
3. –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç `code ‚Üí access_token`
4. –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å GitHub (`/user`)
5. –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç email (`/user/emails`) –µ—Å–ª–∏ —Å–∫—Ä—ã—Ç
6. —Å–æ–∑–¥–∞—ë—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
7. —Å–æ–∑–¥–∞—ë—Ç refresh-cookie + access_token
8. —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `https://{redirect_host}/auth/success?token=...`

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ GitHub

* Email –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫—Ä—ã—Ç ‚Äî –¥–µ–ª–∞–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ `/user/emails`
* –ï—Å–ª–∏ email –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã—Ç ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è `github_{id}@301.st`
* GitHub API —Ç—Ä–µ–±—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `User-Agent`

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ UI

```javascript
// –ò–Ω–∏—Ü–∏–∞—Ü–∏—è OAuth —Å –ø–µ—Ä–µ–¥–∞—á–µ–π —Ç–µ–∫—É—â–µ–≥–æ —Ö–æ—Å—Ç–∞
function startGitHubOAuth() {
  const host = window.location.host;
  const url = `https://api.301.st/auth/oauth/github/start?redirect_host=${encodeURIComponent(host)}`;
  window.location.href = url;
}
```

---

## 2.7 Account Linking (—Å–≤—è–∑—ã–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤)

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è —Å email + password
2. –ü–æ–∑–∂–µ –≤–æ—à—ë–ª —á–µ—Ä–µ–∑ OAuth (Google/GitHub) —Å —Ç–µ–º –∂–µ email

–°–∏—Å—Ç–µ–º–∞ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç –∞–∫–∫–∞—É–Ω—Ç—ã**:

* –û–±–Ω–æ–≤–ª—è–µ—Ç `oauth_provider` –∏ `oauth_id` –≤ users
* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç **–¥–≤–∞ —Å–ø–æ—Å–æ–±–∞ –≤—Ö–æ–¥–∞**: –ø–∞—Ä–æ–ª—å + OAuth
* –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–∫–∫–∞—É–Ω—Ç –∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

**–ü—Ä–∏–º–µ—Ä –≤ –ë–î:**

```sql
-- –î–æ OAuth login:
| id | email              | password_hash | oauth_provider | oauth_id |
|----|--------------------| --------------|----------------|----------|
| 5  | user@example.com   | $pbkdf2...    | null           | null     |

-- –ü–æ—Å–ª–µ GitHub login:
| id | email              | password_hash | oauth_provider | oauth_id  |
|----|--------------------| --------------|----------------|-----------|
| 5  | user@example.com   | $pbkdf2...    | github         | 200593006 |
```

---

## 2.8 –ü–æ–≤–µ–¥–µ–Ω–∏–µ UI –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

* –ü—Ä–æ–≤–µ—Ä–∫–∞ Turnstile –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
* –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (8+ —Å–∏–º–≤–æ–ª–æ–≤, A-Z, a-z, 0-9)
* –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è (pending)
* –î–ª—è email ‚Äî –æ–∂–∏–¥–∞–Ω–∏–µ –∫–ª–∏–∫–∞ –ø–æ —Å—Å—ã–ª–∫–µ + –ø–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏—è "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É"
* –î–ª—è phone ‚Äî —Ñ–æ—Ä–º–∞ –¥–ª—è –≤–≤–æ–¥–∞ OTP —Å —Ç–∞–π–º–µ—Ä–æ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
* –î–ª—è Telegram ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥
* –î–ª—è OAuth ‚Äî redirect flow —á–µ—Ä–µ–∑ popup –∏–ª–∏ –ø–æ–ª–Ω—ã–π redirect
* –ü–æ—Å–ª–µ verify ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ access_token + refresh cookie

---

# 3. –í—Ö–æ–¥ (Login)

```mermaid
flowchart LR
  UI -->|login| Auth[/POST \/auth\/login/]
  Auth --> Tokens[[access_token + refresh_cookie]]
  Tokens --> UI
```

## 3.1 Email / Phone + Password ‚Äî POST /auth/login

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –ø–æ –ø–∞—Ä–æ–ª—é. –ë–µ–∑ –ø–∏—Å–µ–º, –±–µ–∑ SMS, –±–µ–∑ OmniFlow.
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `access_token`, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `refresh_cookie`, –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `active_account_id`.

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**

```
Content-Type: application/json
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**

| –ü–æ–ª–µ | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|-------------|----------|
| `email` | string | –¥–∞* | Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `phone` | string | –¥–∞* | –¢–µ–ª–µ—Ñ–æ–Ω (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ email) |
| `password` | string | –¥–∞ | –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `turnstile_token` | string | –¥–∞ | –¢–æ–∫–µ–Ω Cloudflare Turnstile |

*–¢—Ä–µ–±—É–µ—Ç—Å—è `email` –ò–õ–ò `phone`

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```bash
curl -X POST https://api.301.st/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "SecurePass123!",
    "turnstile_token": "CLIENT_TURNSTILE_TOKEN"
  }'
```

**–ü—Ä–∏–º–µ—Ä —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "ok": true,
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "expires_in": 900,
  "active_account_id": 1
}
```

**Cookies (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º):**

```
Set-Cookie: refresh_id=<uuid>; HttpOnly; Secure; SameSite=Strict; Path=/; Max-Age=604800
```

---

## 3.2 Telegram Mini-App Auto-Login ‚Äî POST /auth/login

**–û–ø–∏—Å–∞–Ω–∏–µ:**
Telegram WebApp –ø–µ—Ä–µ–¥–∞—ë—Ç `initData`, –ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–µ Telegram. API –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –ø–∞—Ä–æ–ª—è –∏ –±–µ–∑ Turnstile.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**

| –ü–æ–ª–µ | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|-------------|----------|
| `tg_init` | object | –¥–∞ | –û–±—ä–µ–∫—Ç initData –∏–∑ Telegram WebApp |

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "ok": true,
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "expires_in": 900,
  "active_account_id": 5
}
```

---

## 3.3 –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–∞—Ä–æ–ª—é

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|------------|----------|
| –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ | 8 —Å–∏–º–≤–æ–ª–æ–≤ |
| –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ | 128 —Å–∏–º–≤–æ–ª–æ–≤ |
| –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –ú–∏–Ω–∏–º—É–º 1 –∑–∞–≥–ª–∞–≤–Ω–∞—è –±—É–∫–≤–∞ (A-Z) |
| –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –ú–∏–Ω–∏–º—É–º 1 —Å—Ç—Ä–æ—á–Ω–∞—è –±—É–∫–≤–∞ (a-z) |
| –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –ú–∏–Ω–∏–º—É–º 1 —Ü–∏—Ñ—Ä–∞ (0-9) |
| –ó–∞–ø—Ä–µ—â–µ–Ω–æ | –ü–∞—Ä–æ–ª–∏ –∏–∑ blacklist (password, 12345678, qwerty123 –∏ –¥—Ä.) |

---

## 3.4 –û—à–∏–±–∫–∏ Login

| –ö–æ–¥ | HTTP | –û–ø–∏—Å–∞–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ UI |
|-----|------|----------|-------------|
| `invalid_login` | 401 | –ù–µ–≤–µ—Ä–Ω—ã–π email/phone –∏–ª–∏ –ø–∞—Ä–æ–ª—å | –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å reset |
| `missing_credentials` | 400 | –ù–µ –ø–µ—Ä–µ–¥–∞–Ω email/phone –∏–ª–∏ password | –ü–æ–∫–∞–∑–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ñ–æ—Ä–º—ã |
| `no_account` | 403 | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ | –°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π |
| `turnstile_failed` | 400 | –ù–µ –ø—Ä–æ–π–¥–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ Turnstile | –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–∂–µ—Ç |

---

## 3.5 –ü–æ–≤–µ–¥–µ–Ω–∏–µ UI –ø–æ—Å–ª–µ Login

1. UI –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ä–º—É –Ω–∞ `/auth/login`.
2. –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Turnstile ‚Üí –ø–∞—Ä–æ–ª—å ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã.
3. –°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `refresh_id` cookie.
4. UI —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `access_token` **—Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏** (–Ω–µ localStorage!).
5. UI –≤—ã–ø–æ–ª–Ω—è–µ—Ç redirect –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç.

Refresh-cookie –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –º–µ–∂–¥—É –¥–æ–º–µ–Ω–∞–º–∏
–û–Ω –æ—Å—Ç–∞—ë—Ç—Å—è host-only —Ç–æ–ª—å–∫–æ –Ω–∞ api.301.st, –∫–∞–∫ –∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å.

–ï—Å–ª–∏ –¥–ª—è –≤—Ö–æ–¥–∞ –∏ –∫–∞–±–∏–Ω–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ –¥–æ–º–µ–Ω—ã, —Ç–æ
–º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å Access-token (–∫–æ—Ä–æ—Ç–∫–∏–π -15 –º–∏–Ω) —á–µ—Ä–µ–∑ query / fragment / postMessage.
–î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ª—É—á—à–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤ #fragment, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ª–æ–≥–∏—Ä–æ–≤–∞–ª URL

```
https://app.301.st/#token=<jwt>
```

app.301.st —Å–∞–º –≤–æ–∑—å–º—ë—Ç refresh-cookie –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ:
```
POST https://api.301.st/auth/refresh
credentials: 'include'
```
–ë—Ä–∞—É–∑–µ—Ä —Å–∞–º –æ—Ç–ø—Ä–∞–≤–∏—Ç refresh_id ‚Üí app –ø–æ–ª—É—á–∏—Ç –Ω–æ–≤—ã–π access_token ‚Üí —Ä–∞–±–æ—Ç–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞.
–ü–æ—Å–ª–µ —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è ‚Äî —É–¥–∞–ª–∏—Ç—å —Ç–æ–∫–µ–Ω –∏–∑ URL

```
<script type="module">
const API_ROOT = 'https://api.301.st/auth';

let currentToken = '';
let hasSession = false;

const setWSVar = (name, value) => {
  try {
    if (typeof window.webstudioSetVariable === "function") {
      window.webstudioSetVariable(name, value);
    }
  } catch {}
};

function setToken(t = '') {
  currentToken = t;
  setWSVar('authBearer', t ? `Bearer ${t}` : '');
  window.dispatchEvent(new CustomEvent('auth:token', { detail: { token: t }}));
}

async function handleOAuthSuccessPage() {
  const url = new URL(location.href);
  const token = url.searchParams.get('token');

  if (!token) {
    document.body.innerHTML = `
      <div class="box">
        <h2>OAuth Error</h2>
        <p>No token provided.</p>
        <p><a href="/">Back</a></p>
      </div>`;
    return;
  }

  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ –ø–∞–º—è—Ç—å
  hasSession = true;
  setToken(token);

  // —É–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω –∏–∑ URL
  history.replaceState(null, '', location.pathname);

  // —Ä–µ–¥–∏—Ä–µ–∫—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ SaaS
  location.href = 'https://app.301.st';
}

handleOAuthSuccessPage();
</script>

```

---

# 4. OmniFlow (Verify)

```mermaid
flowchart LR
  Register[/POST \/auth\/register/] --> OmniToken[[omni-token]]
  Reset[/POST \/auth\/reset_password/] --> OmniToken
  UI -->|verify| VerifyAPI[/POST \/auth\/verify/]
  VerifyAPI --> Tokens[[access_token + refresh_cookie]]
  Tokens --> UI
```

## 4.1 –ß—Ç–æ —Ç–∞–∫–æ–µ omni-token

OmniFlow ‚Äî —ç—Ç–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π:

* —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (email-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ / phone-OTP)
* –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ (reset)

Login **–Ω–µ** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç OmniFlow.

Omni-token —Å–æ–¥–µ—Ä–∂–∏—Ç:

* type: `register` / `reset`
* identifier: email –∏–ª–∏ phone
* channel: email / phone
* payload: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, CSRF token)
* TTL: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ (15 –º–∏–Ω—É—Ç)

---

## 4.2 POST /auth/verify ‚Äî –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ register/reset

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è OmniFlow. –ü–æ omni-token –≤—ã–ø–æ–ª–Ω—è–µ—Ç:

* —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –Ω–æ–≤—ã–π)
* —Å–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ (–¥–ª—è register)
* —Å–æ–∑–¥–∞–Ω–∏–µ membership (—Ä–æ–ª—å owner)
* —Å–æ–∑–¥–∞–Ω–∏–µ server-side session
* —É—Å—Ç–∞–Ω–æ–≤–∫—É refresh-cookie
* –≤—ã–¥–∞—á—É access_token

**–ú–µ—Ç–æ–¥:** `POST` (–Ω–µ GET!)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**

| –ü–æ–ª–µ | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|-------------|----------|
| `token` | string | –¥–∞ | Omni-token –∏–∑ email/SMS |
| `code` | string | –Ω–µ—Ç | OTP –∫–æ–¥ (–¥–ª—è phone/telegram) |

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```bash
curl -X POST https://api.301.st/auth/verify \
  -H "Content-Type: application/json" \
  -d '{
    "token": "qtAvvHBGxI5oKdTAuPb5y"
  }'
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (register):**

```json
{
  "ok": true,
  "user": {
    "id": 5,
    "email": "user@example.com",
    "user_type": "client"
  },
  "accounts": [
    {
      "id": 7,
      "role": "owner",
      "status": "active"
    }
  ],
  "active_account_id": 7,
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "expires_in": 900
}
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (reset) ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π flow:**

```json
{
  "ok": true,
  "type": "reset",
  "user_id": 5,
  "csrf_token": "550e8400-e29b-41d4-a716-446655440000",
  "message": "reset_verified_proceed_to_confirm"
}
```

–ü—Ä–∏ reset —Ç–∞–∫–∂–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è cookie:

```
Set-Cookie: reset_session=<uuid>; HttpOnly; Secure; SameSite=Strict; Path=/; Max-Age=900
```

---

## 4.3 –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–¥–∞ (OTP)

–ï—Å–ª–∏ –∫–∞–Ω–∞–ª —Ç—Ä–µ–±—É–µ—Ç OTP (—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ telegram):

```bash
curl -X POST https://api.301.st/auth/verify \
  -H "Content-Type: application/json" \
  -d '{
    "token": "omni_otp_abc123",
    "code": "123456"
  }'
```

* –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
* OmniFlow –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
* –≤—ã–¥–∞—é—Ç—Å—è —Ç–æ–∫–µ–Ω—ã

---

## 4.4 –û—à–∏–±–∫–∏ Verify

| –ö–æ–¥ | HTTP | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|------|----------|
| `missing_token` | 400 | –ù–µ –ø–µ—Ä–µ–¥–∞–Ω token |
| `invalid_token` | 400 | –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω |
| `expired_token` | 400 | –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ (TTL 15 –º–∏–Ω—É—Ç) |
| `invalid_code` | 400 | –ù–µ–≤–µ—Ä–Ω—ã–π OTP –∫–æ–¥ |

---

## 4.5 UI-–ª–æ–≥–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π

1. –ü–æ—Å–ª–µ `/auth/register` –∏–ª–∏ `/auth/reset_password` UI –ø–æ–ª—É—á–∞–µ—Ç `token`.
2. –ï—Å–ª–∏ channel = email ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É", –∂–¥–∞—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ —Å—Å—ã–ª–∫–µ.
3. –ï—Å–ª–∏ channel = phone ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞ OTP —Å —Ç–∞–π–º–µ—Ä–æ–º.
4. –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ —Å—Å—ã–ª–∫–µ ‚Äî UI –≤—ã–∑—ã–≤–∞–µ—Ç `POST /auth/verify`.
5. –ü–æ–ª—É—á–∞–µ—Ç `access_token` + `refresh_cookie` (–∏–ª–∏ `csrf_token` –¥–ª—è reset).
6. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç access_token –≤ –ø–∞–º—è—Ç–∏.
7. –î–µ–ª–∞–µ—Ç redirect –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç (–∏–ª–∏ –Ω–∞ —Ñ–æ—Ä–º—É —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è –¥–ª—è reset).

---

# 5. –†–∞–±–æ—Ç–∞ —Å —Å–µ—Å—Å–∏—è–º–∏

```mermaid
flowchart LR
  UI -->|access_token expired| Refresh[/POST \/auth\/refresh/]
  Refresh --> NewToken[[new access_token]]
  NewToken --> UI
```

## 5.1 Refresh cookie ‚Äî –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ

* Refresh token —Ö—Ä–∞–Ω–∏—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –≤ HttpOnly cookie `refresh_id`.
* UI –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ refresh-—Ç–æ–∫–µ–Ω—É –Ω–∞–ø—Ä—è–º—É—é.
* UI –ª–∏—à—å –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å `/auth/refresh`, cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

–ü–æ–≤–µ–¥–µ–Ω–∏–µ:

1. `access_token` –∂–∏–≤—ë—Ç ~15 –º–∏–Ω—É—Ç.
2. –ö–æ–≥–¥–∞ –æ–Ω –∏—Å—Ç–µ–∫–∞–µ—Ç ‚Äî UI –≤—ã–∑—ã–≤–∞–µ—Ç `/auth/refresh`.
3. –°–µ—Ä–≤–µ—Ä –≤—ã–¥–∞—ë—Ç –Ω–æ–≤—ã–π `access_token`.
4. Refresh-—Ç–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤—É–µ—Ç 7 –¥–Ω–µ–π (–∏–ª–∏ –¥–æ logout).

---

## 5.2 POST /auth/refresh ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ access_token

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–û–±–Ω–æ–≤–ª—è–µ—Ç access token –ø–æ –¥–µ–π—Å—Ç–≤—É—é—â–µ–º—É refresh cookie.
–í—ã–ø–æ–ª–Ω—è–µ—Ç **—Ä–æ—Ç–∞—Ü–∏—é refresh token** ‚Äî —Å—Ç–∞—Ä—ã–π —É–¥–∞–ª—è–µ—Ç—Å—è, —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π.

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**

```
Cookie: refresh_id=<uuid>
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```bash
curl -X POST https://api.301.st/auth/refresh \
  -H "Cookie: refresh_id=abcd-1234-efgh-5678"
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "status": "ok",
  "access_token": "eyJhbGciOiJIUzI1NiIs..."
}
```

**–ù–æ–≤—ã–π refresh cookie —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**

```
Set-Cookie: refresh_id=<new-uuid>; HttpOnly; Secure; SameSite=Strict; Path=/; Max-Age=604800
```

---

## 5.3 Session Hijacking Protection

–ü—Ä–∏ –∫–∞–∂–¥–æ–º refresh –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è:

* **IP –∞–¥—Ä–µ—Å** ‚Äî –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å IP –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏
* **User-Agent** ‚Äî –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å UA –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏

–ï—Å–ª–∏ IP –∏–ª–∏ UA –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç:

1. Refresh token **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–¥–∞–ª—è–µ—Ç—Å—è** –∏–∑ KV
2. –°–æ–±—ã—Ç–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ audit_log
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ `session_hijack_detected`

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏:**

```json
{
  "message": "session_hijack_detected",
  "details": "IP address mismatch"
}
```

**–î–µ–π—Å—Ç–≤–∏–µ UI:** Redirect –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–æ–≥–∏–Ω–∞ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

---

## 5.4 POST /auth/logout ‚Äî –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏

```mermaid
flowchart LR
  UI --> Logout[/POST \/auth\/logout/]
  Logout --> ClearKV[[–£–¥–∞–ª–µ–Ω–∏–µ refresh-—Ç–æ–∫–µ–Ω–∞ –≤ KV]]
  ClearKV --> ClearCookie[[–°–±—Ä–æ—Å refresh_id cookie]]
  ClearCookie --> UI
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å–µ—Å—Å–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

* —É–¥–∞–ª—è–µ—Ç refresh-—Ç–æ–∫–µ–Ω –∏–∑ KV;
* –æ—á–∏—â–∞–µ—Ç `refresh_id` cookie;
* –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{"status": "ok"}`;
* –ø–æ–º–µ—á–∞–µ—Ç —Å–µ—Å—Å–∏—é –∫–∞–∫ revoked –≤ D1 (–µ—Å–ª–∏ –≤–µ–¥—ë—Ç—Å—è).

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**

```
Cookie: refresh_id=<uuid>
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```bash
curl -X POST https://api.301.st/auth/logout \
  -H "Cookie: refresh_id=fc5b2c90-bd0a-42b1-8043-0f02e7b87abf"
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "status": "ok"
}
```

**Cookie –æ—á–∏—â–∞–µ—Ç—Å—è:**

```
Set-Cookie: refresh_id=; Max-Age=0; Path=/; HttpOnly; Secure; SameSite=Strict
```

---

## 5.5 –ü–æ–≤–µ–¥–µ–Ω–∏–µ UI –ø—Ä–∏ logout

1. UI –≤—ã–∑—ã–≤–∞–µ—Ç `/auth/logout`.
2. –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{"status": "ok"}` –∏ –æ—á–∏—â–∞–µ—Ç cookie.
3. UI –¥–æ–ª–∂–µ–Ω —É–¥–∞–ª–∏—Ç—å `access_token` –∏–∑ –ø–∞–º—è—Ç–∏.
4. UI –≤—ã–ø–æ–ª–Ω—è–µ—Ç redirect –Ω–∞ —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞.

---

## 5.6 –¢–∏–ø–∏—á–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ UI –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞

1. UI –≤—ã–∑—ã–≤–∞–µ—Ç –∑–∞—â–∏—â—ë–Ω–Ω—ã–π API.
2. API –æ—Ç–≤–µ—á–∞–µ—Ç `401 unauthorized`.
3. UI –¥–µ–ª–∞–µ—Ç `POST /auth/refresh`.
4. –ï—Å–ª–∏ refresh –≤–∞–ª–∏–¥–µ–Ω ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–π access token ‚Üí –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å.
5. –ï—Å–ª–∏ refresh –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ `session_hijack_detected` ‚Üí redirect –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–æ–≥–∏–Ω–∞.

---

# 6. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

```mermaid
flowchart LR
  UI -->|GET| Me[/GET \/auth\/me/]
  Me --> UserData[[user + accounts + active_account_id]]
  UserData --> UI
```

## 6.1 GET /auth/me ‚Äî –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ –≤—Å–µ—Ö –µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞—Ö.
–¢—Ä–µ–±—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π `access_token` –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ Authorization.

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**

```
Authorization: Bearer <access_token>
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```bash
curl -X GET https://api.301.st/auth/me \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIs..."
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "ok": true,
  "user": {
    "id": 5,
    "email": "user@example.com",
    "phone": null,
    "tg_id": null,
    "name": "John Doe",
    "user_type": "client",
    "created_at": "2025-11-21T12:38:24.000Z",
    "updated_at": "2025-11-21T14:53:42.580Z"
  },
  "accounts": [
    {
      "id": 7,
      "role": "owner",
      "status": "active",
      "owner_user_id": 5
    },
    {
      "id": 12,
      "role": "editor",
      "status": "active",
      "owner_user_id": 11
    }
  ],
  "active_account_id": 7
}
```

---

## 6.2 –°–ø–∏—Å–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ ‚Äî —á—Ç–æ –≤—ã–≤–æ–¥–∏—Ç—å –Ω–∞ UI

UI –¥–æ–ª–∂–µ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å:

* –Ω–∞–∑–≤–∞–Ω–∏–µ / –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
* —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `owner`, `editor`, `viewer`
* —Å—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞: `active` / `suspended`

UI –º–æ–∂–µ—Ç –¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤—ã–±–æ—Ä —Å–º–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞.

---

## 6.3 active_account_id ‚Äî –ª–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞

* –ø—Ä–∏ login / verify —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–¥–∞—ë—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π `active_account_id`
* –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ ‚Äî UI –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –∏—Ö
* UI –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `account_id` –≤ —Ä–∞–±–æ—á–∏–µ API (–ø–æ –º–µ—Ä–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)

–ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ active_account_id –Ω–∞ –±—ç–∫–µ–Ω–¥–µ:

1. –µ—Å–ª–∏ –µ—Å—Ç—å `owner` –∞–∫–∫–∞—É–Ω—Ç ‚Üí –æ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π
2. –∏–Ω–∞—á–µ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –∏–∑ —Å–ø–∏—Å–∫–∞
3. –µ—Å–ª–∏ –≤ JWT –µ—Å—Ç—å `account_id`, –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π

---

## 6.4 –û—à–∏–±–∫–∏ /auth/me

| –ö–æ–¥ | HTTP | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|------|----------|
| `missing_token` | 401 | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Authorization header |
| `unauthorized` | 401 | JWT –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç—ë–∫ |
| `user_not_found` | 404 | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω |
| `no_accounts` | 403 | –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤ |

---

# 7. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ UI

```mermaid
flowchart LR
  UI --> API
  API -->|error| UI
  UI --> Handler[[UI Error Handler]]
```

## 7.1 –û–±—â–∏–µ –æ—à–∏–±–∫–∏ (400 / 401 / 403)

* **400 Bad Request** ‚Äî –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–ø—Ä–æ—Å–µ (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ, –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç).
* **401 Unauthorized** ‚Äî –Ω–µ—Ç access_token –∏–ª–∏ –æ–Ω –Ω–µ–≤–µ—Ä–µ–Ω.
* **403 Forbidden** ‚Äî –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—É—Ä—Å—É (–Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ –∏–ª–∏ —Ä–æ–ª–∏).

UI –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å: *"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ"*.

---

## 7.2 –û—à–∏–±–∫–∏ Turnstile

–í–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ password-login.

| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|
| `turnstile_failed` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞ |
| `turnstile_required` | –¢–æ–∫–µ–Ω –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω |

UI –¥–µ–π—Å—Ç–≤–∏—è:

1. –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å widget Turnstile
2. –¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É

---

## 7.3 –û—à–∏–±–∫–∏ OmniFlow

–í–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–∏ verify:

| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|
| `missing_token` | –¢–æ–∫–µ–Ω –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω |
| `invalid_token` | –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω |
| `expired_token` | –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ |
| `invalid_code` | –ù–µ–≤–µ—Ä–Ω—ã–π OTP |

UI –¥–µ–π—Å—Ç–≤–∏—è:

* –¥–ª—è email: –∑–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É
* –¥–ª—è phone: –¥–∞—Ç—å —Å–Ω–æ–≤–∞ –≤–≤–µ—Å—Ç–∏ –∫–æ–¥ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—ã–π

---

## 7.4 –û—à–∏–±–∫–∏ –ª–æ–≥–∏–Ω–∞

| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ UI |
|-----|----------|-------------|
| `invalid_login` | –ù–µ–≤–µ—Ä–Ω—ã–π email/phone –∏–ª–∏ –ø–∞—Ä–æ–ª—å | –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å reset |
| `no_account` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ | –°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π |
| `missing_credentials` | –ù–µ –ø–µ—Ä–µ–¥–∞–Ω email/phone/password | –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã |

---

## 7.5 –û—à–∏–±–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ UI |
|-----|----------|-------------|
| `email_required` | –ù–µ –ø–µ—Ä–µ–¥–∞–Ω email | –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã |
| `user_already_registered` | Email –∑–∞–Ω—è—Ç | –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å login –∏–ª–∏ reset |
| `password_too_weak` | –°–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å | –ü–æ–∫–∞–∑–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è |
| `password_too_short` | –ö–æ—Ä–æ—Ç–∫–∏–π –ø–∞—Ä–æ–ª—å | –ü–æ–∫–∞–∑–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤ |
| `password_too_common` | –ü–∞—Ä–æ–ª—å –∏–∑ blacklist | –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –¥—Ä—É–≥–æ–π |

---

## 7.6 –û—à–∏–±–∫–∏ Reset Password

| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ UI |
|-----|----------|-------------|
| `oauth_only` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –ø–∞—Ä–æ–ª—è | –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –¥–ª—è –≤—Ö–æ–¥–∞ |
| `email_not_verified` | Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω | –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ |
| `reset_session_required` | –ù–µ—Ç reset_session cookie | –ù–∞—á–∞—Ç—å reset –∑–∞–Ω–æ–≤–æ |
| `reset_session_expired` | –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ | –ù–∞—á–∞—Ç—å reset –∑–∞–Ω–æ–≤–æ |
| `csrf_token_required` | –ù–µ –ø–µ—Ä–µ–¥–∞–Ω CSRF —Ç–æ–∫–µ–Ω | –û—à–∏–±–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ |
| `csrf_token_invalid` | –ù–µ–≤–µ—Ä–Ω—ã–π CSRF —Ç–æ–∫–µ–Ω | –ù–∞—á–∞—Ç—å reset –∑–∞–Ω–æ–≤–æ |
| `password_reused` | –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å = —Å—Ç–∞—Ä—ã–π | –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –¥—Ä—É–≥–æ–π –ø–∞—Ä–æ–ª—å |

---

## 7.7 –û—à–∏–±–∫–∏ Change Password

| –ö–æ–¥ | HTTP | –û–ø–∏—Å–∞–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ UI |
|-----|------|----------|-------------|
| `unauthorized` | 401 | –ù–µ—Ç access_token | Redirect –Ω–∞ login |
| `current_password_and_new_password_required` | 400 | –ù–µ –ø–µ—Ä–µ–¥–∞–Ω—ã –ø–æ–ª—è | –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã |
| `oauth_only` | 400 | –¢–æ–ª—å–∫–æ OAuth-–≤—Ö–æ–¥ | –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ |
| `wrong_password` | 400 | –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å | –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É |
| `password_too_weak` | 400 | –°–ª–∞–±—ã–π –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å | –ü–æ–∫–∞–∑–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è |
| `same_password` | 400 | –ù–æ–≤—ã–π = —Ç–µ–∫—É—â–∏–π | –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –¥—Ä—É–≥–æ–π |

---

## 7.8 –û—à–∏–±–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

| –ö–æ–¥ | HTTP | –û–ø–∏—Å–∞–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ UI |
|-----|------|----------|-------------|
| `session_hijack_detected` | 401 | –ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –Ω–∞ –∫—Ä–∞–∂—É —Å–µ—Å—Å–∏–∏ | Redirect –Ω–∞ login + –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ |
| `rate_limit_exceeded` | 429 | –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ | –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–π–º–µ—Ä retry |

---

# 8. –ü—Ä–∏–º–µ—Ä—ã UI-—Ñ–ª–æ—É

```mermaid
flowchart LR
  Start(UI) --> Step1["–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã ‚ûú /auth/register –∏–ª–∏ /auth/login"]
  Step1 --> Step2["–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–ª–∏ –æ—à–∏–±–∫–∏"]
  Step2 --> Step3["–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞ —Ñ–ª–æ—É"]
  Step3 --> Finish["–ü–æ–ª—É—á–µ–Ω–∏–µ access_token + redirect"]
```

---

## 8.1 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: email + password

1. UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É: email, password, Turnstile widget.
2. UI –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–∞—Ä–æ–ª—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (8+ —Å–∏–º–≤–æ–ª–æ–≤, A-Z, a-z, 0-9).
3. UI –ø–æ–ª—É—á–∞–µ—Ç Turnstile token.
4. UI –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `POST /auth/register` —Å email + password + turnstile_token.
5. API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `status: pending` –∏ `token`.
6. UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è".
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç —Å—Å—ã–ª–∫—É –∏–∑ –ø–∏—Å—å–º–∞.
8. UI (–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /auth/verify) –∏–∑–≤–ª–µ–∫–∞–µ—Ç token –∏–∑ URL.
9. UI –≤—ã–∑—ã–≤–∞–µ—Ç `POST /auth/verify` —Å `{"token": "..."}`.
10. –ü–æ–ª—É—á–∞–µ—Ç `access_token` ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ø–∞–º—è—Ç–∏ ‚Üí redirect –≤ –õ–ö.

---

## 8.2 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: phone + OTP

1. UI –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `POST /auth/register` —Å phone + password.
2. API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `status: code_required` –∏ `token`.
3. UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É OTP —Å —Ç–∞–π–º–µ—Ä–æ–º (60 —Å–µ–∫).
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∫–æ–¥ –∏–∑ SMS.
5. UI –≤—ã–∑—ã–≤–∞–µ—Ç `POST /auth/verify` —Å `{"token": "...", "code": "123456"}`.
6. –ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã ‚Üí redirect.

---

## 8.3 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: Google OAuth

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google".
2. UI –¥–µ–ª–∞–µ—Ç redirect –Ω–∞ `https://api.301.st/auth/oauth/google/start`.
3. –ë—Ä–∞—É–∑–µ—Ä —É—Ö–æ–¥–∏—Ç –Ω–∞ Google ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è.
4. Google —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ callback ‚Üí —Å–µ—Ä–≤–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç.
5. –ë—Ä–∞—É–∑–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç redirect –Ω–∞ `https://301.st/auth/success?token=JWT`.
6. UI –∏–∑–≤–ª–µ–∫–∞–µ—Ç token –∏–∑ URL ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ø–∞–º—è—Ç–∏ ‚Üí redirect –≤ –õ–ö.

---

## 8.4 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: GitHub OAuth

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ GitHub".
2. UI –¥–µ–ª–∞–µ—Ç redirect –Ω–∞ `https://api.301.st/auth/oauth/github/start`.
3. –ë—Ä–∞—É–∑–µ—Ä —É—Ö–æ–¥–∏—Ç –Ω–∞ GitHub ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è.
4. GitHub —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ callback ‚Üí —Å–µ—Ä–≤–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç.
5. –ë—Ä–∞—É–∑–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç redirect –Ω–∞ `https://301.st/auth/success?token=JWT`.
6. UI –∏–∑–≤–ª–µ–∫–∞–µ—Ç token –∏–∑ URL ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ø–∞–º—è—Ç–∏ ‚Üí redirect –≤ –õ–ö.

---

## 8.5 –í—Ö–æ–¥: password-login

1. UI –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `POST /auth/login` —Å email + password + turnstile_token.
2. –ü–æ–ª—É—á–∞–µ—Ç `access_token` + refresh_cookie (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏).
3. UI —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç access_token –≤ –ø–∞–º—è—Ç–∏.
4. UI –¥–µ–ª–∞–µ—Ç redirect –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç.

---

## 8.6 –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞

1. UI –≤—ã–∑—ã–≤–∞–µ—Ç –∑–∞—â–∏—â—ë–Ω–Ω—ã–π endpoint.
2. –ü–æ–ª—É—á–∞–µ—Ç `401 unauthorized` (—Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫).
3. UI –¥–µ–ª–∞–µ—Ç `POST /auth/refresh` (cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏).
4. –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–π `access_token`.
5. UI –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º.

---

## 8.7 Logout

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–í—ã–π—Ç–∏".
2. UI –≤—ã–∑—ã–≤–∞–µ—Ç `POST /auth/logout`.
3. –°–µ—Ä–≤–µ—Ä —É–¥–∞–ª—è–µ—Ç refresh –∏–∑ KV, –æ—á–∏—â–∞–µ—Ç cookie.
4. UI —É–¥–∞–ª—è–µ—Ç access_token –∏–∑ –ø–∞–º—è—Ç–∏.
5. UI –¥–µ–ª–∞–µ—Ç redirect –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞.

---

# 9. Reset Password Flow

```mermaid
flowchart LR
  Start[UI: Forgot Password] --> ResetRequest[/POST \/auth\/reset_password/]
  ResetRequest --> Email[[Email —Å —Å—Å—ã–ª–∫–æ–π]]
  Email --> ClickLink[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç]
  ClickLink --> Verify[/POST \/auth\/verify/]
  Verify --> ResetSession[[reset_session cookie + CSRF token]]
  ResetSession --> PasswordForm[UI: –§–æ—Ä–º–∞ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è]
  PasswordForm --> Confirm[/POST \/auth\/confirm_password/]
  Confirm --> Success[[–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω]]
  Success --> Login[Redirect –Ω–∞ Login]
```

## 9.1 POST /auth/reset_password ‚Äî –∑–∞–ø—Ä–æ—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email —Å–æ —Å—Å—ã–ª–∫–æ–π –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è.
–î–ª—è OAuth-only –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**

| –ü–æ–ª–µ | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|-------------|----------|
| `type` | string | –¥–∞ | –ö–∞–Ω–∞–ª: `email` –∏–ª–∏ `tg` |
| `value` | string | –¥–∞ | Email –∏–ª–∏ Telegram ID |
| `turnstile_token` | string | –¥–∞ | –¢–æ–∫–µ–Ω Turnstile |

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```bash
curl -X POST https://api.301.st/auth/reset_password \
  -H "Content-Type: application/json" \
  -d '{
    "type": "email",
    "value": "user@example.com",
    "turnstile_token": "CLIENT_TURNSTILE_TOKEN"
  }'
```

**–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç:**

```json
{
  "status": "ok"
}
```

**–û—Ç–≤–µ—Ç –¥–ª—è OAuth-only –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**

```json
{
  "status": "oauth_only",
  "provider": "google",
  "message": "–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ Google. –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
}
```

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã:**

| Provider | Display Name |
|----------|--------------|
| `google` | Google |
| `github` | GitHub |
| `apple` | Apple |
| `telegram` | Telegram |

---

## 9.2 –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ email

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–∏—Å—å–º–æ —Å–æ —Å—Å—ã–ª–∫–æ–π:

```
https://301.st/auth/verify?type=reset&token=abc123def456
```

UI –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/auth/verify`:

1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç `token` –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.
2. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç `type=reset` ‚Üí —ç—Ç–æ reset flow.
3. –í—ã–∑—ã–≤–∞–µ—Ç `POST /auth/verify`.

---

## 9.3 POST /auth/verify (type=reset)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```bash
curl -X POST https://api.301.st/auth/verify \
  -H "Content-Type: application/json" \
  -d '{
    "token": "abc123def456"
  }'
```

**–û—Ç–≤–µ—Ç:**

```json
{
  "ok": true,
  "type": "reset",
  "user_id": 5,
  "csrf_token": "550e8400-e29b-41d4-a716-446655440000",
  "message": "reset_verified_proceed_to_confirm"
}
```

**–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è cookie:**

```
Set-Cookie: reset_session=<uuid>; HttpOnly; Secure; SameSite=Strict; Path=/; Max-Age=900
```

**–í–∞–∂–Ω–æ:**
* `csrf_token` –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ UI (–≤ –ø–∞–º—è—Ç–∏ –∏–ª–∏ state)
* Cookie `reset_session` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
* TTL —Å–µ—Å—Å–∏–∏ ‚Äî 15 –º–∏–Ω—É—Ç

---

## 9.4 POST /auth/confirm_password ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ó–∞–≤–µ—Ä—à–∞—é—â–∏–π —à–∞–≥ ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è.
–¢—Ä–µ–±—É–µ—Ç: reset_session cookie + CSRF token + –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**

| –ü–æ–ª–µ | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|-------------|----------|
| `password` | string | –¥–∞ | –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å |
| `csrf_token` | string | –¥–∞ | CSRF —Ç–æ–∫–µ–Ω –∏–∑ verify |

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```bash
curl -X POST https://api.301.st/auth/confirm_password \
  -H "Content-Type: application/json" \
  -H "Cookie: reset_session=<uuid>" \
  -d '{
    "password": "NewSecurePass456!",
    "csrf_token": "550e8400-e29b-41d4-a716-446655440000"
  }'
```

**–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç:**

```json
{
  "status": "ok",
  "user_id": 5
}
```

**–ü–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞:**
* –ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω –≤ –ë–î
* –í—Å–µ refresh-—Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã
* reset_session cookie –æ—á–∏—â–µ–Ω

---

## 9.5 –û—à–∏–±–∫–∏ Reset Flow

| –ö–æ–¥ | HTTP | –≠—Ç–∞–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|------|------|----------|
| `oauth_only` | 200 | reset_password | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –ø–∞—Ä–æ–ª—è |
| `email_not_verified` | 400 | reset_password | Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω |
| `expired_token` | 400 | verify | –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ |
| `reset_session_required` | 401 | confirm_password | –ù–µ—Ç cookie |
| `reset_session_expired` | 401 | confirm_password | –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ |
| `csrf_token_required` | 403 | confirm_password | –ù–µ—Ç CSRF |
| `csrf_token_invalid` | 403 | confirm_password | –ù–µ–≤–µ—Ä–Ω—ã–π CSRF |
| `password_too_weak` | 400 | confirm_password | –°–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å |
| `password_reused` | 400 | confirm_password | –°–æ–≤–ø–∞–¥–∞–µ—Ç —Å–æ —Å—Ç–∞—Ä—ã–º |

---

## 9.6 –ü–æ–ª–Ω—ã–π UI Flow

```mermaid
flowchart TD
    A[üîê –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?<br/>email + Turnstile] -->|POST /auth/reset_password| B{OAuth-only?}
    
    B -->|–î–∞| C[‚ùå –ü–æ–∫–∞–∑–∞—Ç—å:<br/>'–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google/GitHub']
    B -->|–ù–µ—Ç| D[üìß Email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω<br/>–°—Å—ã–ª–∫–∞ 15 –º–∏–Ω]
    
    D --> E[üëÜ –ö–ª–∏–∫ –ø–æ —Å—Å—ã–ª–∫–µ<br/>/auth/verify?type=reset&token=xxx]
    
    E -->|POST /auth/verify| F[üé´ –ü–æ–ª—É—á–µ–Ω csrf_token<br/>+ reset_session cookie]
    
    F --> G[üîë –§–æ—Ä–º–∞ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è<br/>password + confirm]
    
    G -->|POST /auth/confirm_password<br/>password + csrf_token| H{–í–∞–ª–∏–¥–∞—Ü–∏—è}
    
    H -->|password_too_weak| G
    H -->|password_reused| G
    H -->|csrf_invalid| I[‚ö†Ô∏è –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ]
    H -->|‚úÖ OK| J[‚úÖ –ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω!<br/>Redirect ‚Üí /login]
```
---

## 9.7 POST /auth/change_password ‚Äî —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è (–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π)

```mermaid
flowchart LR
  UI -->|current + new password| ChangePass[/POST \/auth\/change_password/]
  ChangePass --> Validate[[–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–∞—Ä–æ–ª—è]]
  Validate --> Hash[[–•—ç—à –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è]]
  Hash --> Revoke[[–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è refresh-—Ç–æ–∫–µ–Ω–æ–≤]]
  Revoke --> Success[[ok: password_changed]]
  Success --> UI
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç OmniFlow, CSRF –∏–ª–∏ reset-—Å–µ—Å—Å–∏—é ‚Äî —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–π access_token –∏ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å.

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**

```
Content-Type: application/json
Authorization: Bearer <access_token>
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**

| –ü–æ–ª–µ | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|-------------|----------|
| `current_password` | string | –¥–∞ | –¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å |
| `new_password` | string | –¥–∞ | –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–∑ 3.3) |

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```javascript
// –ò–∑ Browser Console –Ω–∞ app.301.st
fetch("https://api.301.st/auth/change_password", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "Authorization": "Bearer " + token
  },
  body: JSON.stringify({
    current_password: "OldPass123",
    new_password: "NewSecurePass456"
  })
}).then(r => r.json()).then(console.log)
```

**–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç:**

```json
{
  "ok": true,
  "message": "password_changed"
}
```

**–ü–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞:**
* –ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω –≤ –ë–î
* –í—Å–µ refresh-—Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã
* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω–æ –∑–∞–Ω–æ–≤–æ –≤–æ–π—Ç–∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

**–û—à–∏–±–∫–∏:**

| –ö–æ–¥ | HTTP | –û–ø–∏—Å–∞–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ UI |
|-----|------|----------|-------------|
| `unauthorized` | 401 | –ù–µ—Ç –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π access_token | Redirect –Ω–∞ login |
| `current_password_and_new_password_required` | 400 | –ù–µ –ø–µ—Ä–µ–¥–∞–Ω—ã –æ–±–∞ –ø–æ–ª—è | –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã |
| `oauth_only` | 400 | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –ø–∞—Ä–æ–ª—è (—Ç–æ–ª—å–∫–æ OAuth) | –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ |
| `wrong_password` | 400 | –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å | –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É |
| `password_too_weak` | 400 | –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º | –ü–æ–∫–∞–∑–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (3.3) |
| `same_password` | 400 | –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º | –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –¥—Ä—É–≥–æ–π |

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ UI:**

```mermaid
flowchart TD
    A[–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞] --> B[–§–æ—Ä–º–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è<br/>current + new + confirm]
    B -->|POST /auth/change_password| C{–†–µ–∑—É–ª—å—Ç–∞—Ç}
    C -->|wrong_password| D[–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å]
    C -->|password_too_weak| E[–ü–æ–∫–∞–∑–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è]
    C -->|same_password| F[–ü–∞—Ä–æ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç]
    C -->|ok| G[–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω!<br/>Redirect –Ω–∞ login]
```

---

# 10. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ UI

> **–ê—É–¥–∏—Ç–æ—Ä–∏—è:** Frontend-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏, UI/UX —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã  
> **–£—Ä–æ–≤–µ–Ω—å:** –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

```mermaid
flowchart LR
  UI --> Tokens((access_token))
  Tokens --> Memory["In-memory store"]
  UI --> Cookie[[refresh_cookie]]
  Cookie --> Server
```

---

## 10.1 –•—Ä–∞–Ω–µ–Ω–∏–µ access_token

| ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–æ | ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ |
|-------------|-------------|
| Vuex / Pinia (Vue) | localStorage |
| Redux / Zustand (React) | sessionStorage |
| Svelte stores | IndexedDB |
| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –≤ –ø–∞–º—è—Ç–∏ | URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã |
| | Cookies (—Ç–æ–ª—å–∫–æ refresh!) |

**–ü—Ä–∞–≤–∏–ª–∞:**

```javascript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏
const authStore = {
  accessToken: null,
  
  setToken(token) {
    this.accessToken = token;  // –¢–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏
  },
  
  clearToken() {
    this.accessToken = null;
  }
};

// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî localStorage
localStorage.setItem('access_token', token);  // –ù–ò–ö–û–ì–î–ê!
```

**–ü–µ—Ä–µ–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–∞:**

```javascript
// ‚úÖ –¢–æ–ª—å–∫–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ Authorization
fetch('/api/projects', {
  headers: {
    'Authorization': `Bearer ${authStore.accessToken}`
  }
});

// ‚ùå –ù–∏–∫–æ–≥–¥–∞ –≤ URL
fetch(`/api/projects?token=${token}`);  // –ù–ò–ö–û–ì–î–ê!
```

---

## 10.2 –†–∞–±–æ—Ç–∞ —Å refresh cookie

| –°–≤–æ–π—Å—Ç–≤–æ | –ó–Ω–∞—á–µ–Ω–∏–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|------------|
| `HttpOnly` | true | JS –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ |
| `Secure` | true | –¢–æ–ª—å–∫–æ HTTPS |
| `SameSite` | Strict | –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF |
| `Path` | / | –í–µ—Å—å –¥–æ–º–µ–Ω |
| `Max-Age` | 604800 | 7 –¥–Ω–µ–π |

**–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è UI:**

```javascript
// ‚úÖ Cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
fetch('https://api.301.st/auth/refresh', {
  method: 'POST',
  credentials: 'include'  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!
});

// ‚ùå –ù–µ–ª—å–∑—è —á–∏—Ç–∞—Ç—å refresh cookie
document.cookie;  // refresh_id –ù–ï –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω (HttpOnly)

// ‚ùå –ù–µ–ª—å–∑—è —Ö—Ä–∞–Ω–∏—Ç—å refresh –≤ JS
const refreshToken = '...';  // –ù–ò–ö–û–ì–î–ê!
```

---

## 10.3 Cloudflare Turnstile

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

| Endpoint | Turnstile |
|----------|-----------|
| `POST /auth/register` | ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| `POST /auth/login` | ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| `POST /auth/reset_password` | ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| `GET /auth/oauth/*/start` | ‚ùå –ù–µ –Ω—É–∂–Ω–æ |
| `POST /auth/login` (Telegram) | ‚ùå –ù–µ –Ω—É–∂–Ω–æ |
| `POST /auth/refresh` | ‚ùå –ù–µ –Ω—É–∂–Ω–æ |
| `POST /auth/logout` | ‚ùå –ù–µ –Ω—É–∂–Ω–æ |

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

```html
<!-- 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<!-- 2. –í–∏–¥–∂–µ—Ç –≤ —Ñ–æ—Ä–º–µ -->
<div class="cf-turnstile" 
     data-sitekey="0x4AAAAAAA..."
     data-callback="onTurnstileSuccess">
</div>
```

```javascript
// 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–∫–µ–Ω–∞
let turnstileToken = null;

function onTurnstileSuccess(token) {
  turnstileToken = token;
}

// 4. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å —Ñ–æ—Ä–º–æ–π
async function handleRegister(email, password) {
  if (!turnstileToken) {
    showError('–ü—Ä–æ–π–¥–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É');
    return;
  }

  const response = await fetch('https://api.301.st/auth/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      email,
      password,
      turnstile_token: turnstileToken
    })
  });

  if (!response.ok) {
    const data = await response.json();
    if (data.message === 'turnstile_failed') {
      // –°–±—Ä–æ—Å–∏—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å –∑–∞–Ω–æ–≤–æ
      turnstile.reset();
      showError('–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞');
    }
  }
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```javascript
// –ü—Ä–∏ –æ—à–∏–±–∫–µ turnstile_failed
function handleTurnstileError() {
  // 1. –°–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥–∂–µ—Ç
  turnstile.reset();
  
  // 2. –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
  showError('–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
  
  // 3. –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–æ—Ä–º—É –±–µ–∑ –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
}
```

---

## 10.4 –ó–∞—â–∏—Ç–∞ OmniFlow (OTP / Email verification)

### –¢–∞–π–º–µ—Ä –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏

```javascript
// –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ OTP
const OTP_COOLDOWN = 60; // —Å–µ–∫—É–Ω–¥

let canResend = false;
let countdown = OTP_COOLDOWN;

function startCooldown() {
  canResend = false;
  countdown = OTP_COOLDOWN;
  
  const timer = setInterval(() => {
    countdown--;
    updateTimerUI(countdown);
    
    if (countdown <= 0) {
      clearInterval(timer);
      canResend = true;
      showResendButton();
    }
  }, 1000);
}

function handleResendOTP() {
  if (!canResend) {
    showError(`–ü–æ–¥–æ–∂–¥–∏—Ç–µ ${countdown} —Å–µ–∫.`);
    return;
  }
  
  // –ó–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—ã–π OTP
  requestNewOTP();
  startCooldown();
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å—Ç—ë–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤

```javascript
async function verifyToken(token, code) {
  const response = await fetch('https://api.301.st/auth/verify', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ token, code })
  });

  const data = await response.json();

  switch (data.message) {
    case 'expired_token':
      // –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—ã–π
      showExpiredMessage();
      showRequestNewLinkButton();
      break;
      
    case 'invalid_code':
      // –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ ‚Äî –¥–∞—Ç—å –≤–≤–µ—Å—Ç–∏ —Å–Ω–æ–≤–∞
      showError('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
      clearCodeInput();
      focusCodeInput();
      break;
      
    case 'invalid_token':
      // –¢–æ–∫–µ–Ω –ø–æ–≤—Ä–µ–∂–¥—ë–Ω ‚Äî –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
      showError('–°—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞');
      redirectToRegister();
      break;
  }
}
```

### –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è UI

| –î–µ–π—Å—Ç–≤–∏–µ | –ü–æ–≤–µ–¥–µ–Ω–∏–µ |
|----------|-----------|
| –û—Ç–ø—Ä–∞–≤–∫–∞ OTP | –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∞ 60 —Å–µ–∫ |
| –í–≤–æ–¥ –∫–æ–¥–∞ | –ú–∞–∫—Å–∏–º—É–º 6 —Ü–∏—Ñ—Ä, auto-submit |
| –ò—Å—Ç—ë–∫ —Ç–æ–∫–µ–Ω | –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ó–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É" |
| 3 –Ω–µ–≤–µ—Ä–Ω—ã—Ö –∫–æ–¥–∞ | –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—ã–π |
| –£—Å–ø–µ—Ö | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π redirect |

---

## 10.5 CSRF Protection

### Reset Password Flow

```javascript
// –ü–æ—Å–ª–µ /auth/verify (type=reset) ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å CSRF
async function handleResetVerify(token) {
  const response = await fetch('https://api.301.st/auth/verify', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ token })
  });

  const data = await response.json();

  if (data.type === 'reset') {
    // ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å CSRF –≤ –ø–∞–º—è—Ç–∏ (–Ω–µ localStorage!)
    csrfStore.token = data.csrf_token;
    showNewPasswordForm();
  }
}

// –ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å CSRF
async function handleConfirmPassword(newPassword) {
  const response = await fetch('https://api.301.st/auth/confirm_password', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',  // –û—Ç–ø—Ä–∞–≤–∏—Ç reset_session cookie
    body: JSON.stringify({
      password: newPassword,
      csrf_token: csrfStore.token  // ‚Üê –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!
    })
  });
}
```

### –•—Ä–∞–Ω–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞

| ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–æ | ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ |
|-------------|-------------|
| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –≤ –ø–∞–º—è—Ç–∏ | localStorage |
| sessionStorage (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ) | Cookies |
| React/Vue state | URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã |

---

## 10.6 Session Hijacking ‚Äî —Ä–µ–∞–∫—Ü–∏—è UI

```javascript
async function handleRefresh() {
  const response = await fetch('https://api.301.st/auth/refresh', {
    method: 'POST',
    credentials: 'include'
  });

  if (!response.ok) {
    const data = await response.json();
    
    if (data.message === 'session_hijack_detected') {
      // ‚ö†Ô∏è –ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –Ω–∞ –∫—Ä–∞–∂—É —Å–µ—Å—Å–∏–∏
      
      // 1. –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–æ–∫–µ–Ω—ã
      authStore.clearToken();
      
      // 2. –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
      showSecurityAlert(
        '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. ' +
        '–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç –∑–∞–Ω–æ–≤–æ.'
      );
      
      // 3. Redirect –Ω–∞ login
      redirectToLogin();
      
      // 4. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
      suggestPasswordChange();
    }
  }
}
```

---

## 10.7 –ß–µ–∫-–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ü–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º

**–ü–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º:**
- [ ] access_token —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏
- [ ] –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `credentials: 'include'`
- [ ] Turnstile –Ω–∞ register/login/reset
- [ ] –¢–∞–π–º–µ—Ä OTP (60 —Å–µ–∫)
- [ ] CSRF —Ç–æ–∫–µ–Ω –≤ confirm_password
- [ ] –ü—Ä–∏ logout –æ—á–∏—â–∞–µ—Ç—Å—è access_token
- [ ] –ù–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ –≤ URL
- [ ] –ù–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ –≤ localStorage/sessionStorage
- [ ] Console.log –Ω–µ –≤—ã–≤–æ–¥–∏—Ç —Ç–æ–∫–µ–Ω—ã –≤ production

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```javascript
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ç–æ–∫–µ–Ω—ã –Ω–µ —É—Ç–µ–∫–∞—é—Ç
console.log(localStorage);     // –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–æ–∫–µ–Ω–æ–≤
console.log(sessionStorage);   // –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å access_token
console.log(document.cookie);  // refresh_id –ù–ï –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–¥–µ–Ω
```

---

## 10.8 –ö—Ä–∞—Ç–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ endpoints

| Endpoint | –ú–µ—Ç–æ–¥ | Turnstile | Cookie | CSRF | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã |
|----------|-------|-----------|--------|------|-----------|
| `/auth/register` | POST | ‚úÖ | ‚Äî | ‚Äî | body |
| `/auth/login` | POST | ‚úÖ | ‚Äî | ‚Äî | body |
| `/auth/verify` | POST | ‚Äî | `credentials` | ‚Äî | body |
| `/auth/refresh` | POST | ‚Äî | `credentials` | ‚Äî | ‚Äî |
| `/auth/logout` | POST | ‚Äî | `credentials` | ‚Äî | ‚Äî |
| `/auth/me` | GET | ‚Äî | `Authorization` | ‚Äî | ‚Äî |
| `/auth/reset_password` | POST | ‚úÖ | ‚Äî | ‚Äî | body |
| `/auth/confirm_password` | POST | ‚Äî | `credentials` | ‚úÖ | body |
| `/auth/change_password` | POST | ‚Äî | `Authorization` | ‚Äî | body |
| `/auth/oauth/google/start` | GET | ‚Äî | ‚Äî | ‚Äî | `?redirect_host=` |
| `/auth/oauth/github/start` | GET | ‚Äî | ‚Äî | ‚Äî | `?redirect_host=` |

---

## 10.9 –ü—Ä–∏–º–µ—Ä—ã fetch-–æ–±—ë—Ä—Ç–æ–∫

```javascript
// –ë–∞–∑–æ–≤—ã–π API –∫–ª–∏–µ–Ω—Ç
const api = {
  baseUrl: 'https://api.301.st',
  
  // –ó–∞–ø—Ä–æ—Å —Å access_token
  async authFetch(endpoint, options = {}) {
    const token = authStore.accessToken;
    
    const response = await fetch(`${this.baseUrl}${endpoint}`, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : undefined,
        ...options.headers
      },
      credentials: 'include'
    });
    
    // Auto-refresh –ø—Ä–∏ 401
    if (response.status === 401) {
      const refreshed = await this.refresh();
      if (refreshed) {
        return this.authFetch(endpoint, options);  // Retry
      } else {
        redirectToLogin();
      }
    }
    
    return response;
  },
  
  // Refresh —Ç–æ–∫–µ–Ω–∞
  async refresh() {
    const response = await fetch(`${this.baseUrl}/auth/refresh`, {
      method: 'POST',
      credentials: 'include'
    });
    
    if (response.ok) {
      const data = await response.json();
      authStore.setToken(data.access_token);
      return true;
    }
    
    return false;
  }
};
```

