# Архитектура 301  

## Cloudflare для TDS-платформы 

Цель — предоставить клиентам (арбитражникам, вебмастерам, SEO-специалистам) простую площадку для управления аккаунтом Cloudflare без избыточных функций. 
Руководство ориентировано на бесплатный тариф для клиентов без использования платных и не нужных сервисов (например, D1, KV, Bot Fight Mode). 

Принцип взаимодействия платформы 301 и Cloudflare: шаблоны редиректов, TDS-настроек и общих конфигураций хранятся на стороне платформы, и применяются через API на аккаунте клиента.

## Структура 301
**Проект** = бренд / продукт (логическая группа)
**Сайт** = активный домен (2-го уровня) акцептор, привязан к TDS или физическому серверу
**Зоны** = все домены, связанные с этим сайтом:
- 1 активный домен (работает через Worker → TDS);
- M–1 неактивных (софт-блок, редирект на активный) доноры.

## 1. Обзор тарифных планов Cloudflare (с точки зрения клиента)

Cloudflare предлагает платные тарифы, но для цели управление доменами, редиректами, TDS платный тариф не обязателен. 
Клиент начинает и может оставаться на бесплатном тарифе, для этого 301 реализовывает логику через Workers. 
Применение платныех опций на Cloudflare клиента происходит по решению клиента.
301  — фокусируйтся на обходе лимитов через гибкие инструменты.

### Бесплатный тариф (Free Plan)
 **Доступно без оплаты**: Полноценный контроль для базовых нужд.
 **Ключевые функции**:
  - Управление DNS-зонами (A, CNAME, TXT и др. записи, включая поддомены 2–4 уровня).
  - Workers: До 100 000 запросов в день (~3 млн/мес) — достаточно для TDS и редиректов.
    - Гео, IP, User-Agent: Доступны в Workers для TDS-логики.
  - Redirect Rules: До 10 правил на зону (статические редиректы 301/302, без регулярок или подстановок).
  - Page Rules: До 3 правил на аккаунт (мало для массовых редиректов; можно использовать для кэширования или обхода Workers на статике).
    - Внимание! Это старый способ управлять поведением Cloudflare по URL. Сейчас всё это делается через современные, модульные Rules.
    - Redirect Rules — для редиректов, Cache Rules — для управления кэшем, Firewall Rules — для блокировок по IP, гео, User-Agent и т.д.
  - WAF-правила: до 5 кастомных правил на аккаунт — полезны для блокировки по User-Agent, путям или странам, чтобы снизить нагрузку на Workers.
  - API-доступ: Полный для автоматизации (зоны, Workers, DNS, KV, D1 — через Wrangler и REST API).
  - Universal SSL: Автоматически для всех доменов (включая поддомены).
 **Ограничения**: Нет динамических правил в Redirect Rules (пример: условные редиректы по гео). Лимит Workers — 100k/день (но легко обходить через оптимизацию).
 **Вывод для клиента**: Хватит для 95% сценариев. Платформа (301) реализует редиректы и TDS через Workers, чтобы обойти лимиты Page/Redirect Rules.

### Платные тарифы (Pro / Business / Enterprise)
- **Pro ($20/мес за домен)**:
  - Page Rules: До 20.
  - Workers: До 10 млн запросов/день.
  - Дополнительно: Кастомные SSL, приоритетная поддержка.
  - **Когда нужно?** Редко — только если >10 доменов и клиент настаивает на Page Rules. Не подходит для TDS с динамикой.
- **Business ($200/мес за аккаунт)**:
  - Page Rules: До 50.
  - Workers: До 100 млн запросов/день.
  - Bulk Redirects: Массовые статические редиректы через CSV.
  - Дополнительно: Logpush, Bot Fight Mode.
  - **Когда нужно?** Для очень высоких нагрузок или сложных редиректов. Избыточно для арбитража — TDS лучше на Workers.
- **Workers Paid (отдельная опция, $0.15 за 1 млн запросов)**:
  - Снимает лимит 100k/день без смены тарифа.
  - **Когда нужно?** Только при пиковой нагрузке (>100k посещений/день).
- **Enterprise**: Избыточен.
- **Вывод**: В документации: «Вам не нужен платный тариф — наша система работает на бесплатном Workers».  Вам не нужно создавать Workers, KV-пространства или базы данных — всё это управляется нами.  Просто добавьте домен и настройте правила через панель.

## 2. Расчет нагрузки на Workers (для бесплатного тарифа)

Workers — ключевой инструмент для TDS и редиректов. Каждый запрос (посещение домена) = 1 вызов Worker. Лимит Free: 100 000/день.

### Исходные данные для типичного клиента
- Количество доменов: 5–10 (активные + софт-блоки).
- Посещений на активный домен/день: 1 000–5 000.
- Посещений на неактивный (софт-блок): 500.
- Структура: Проекты (бренды) → Сайты (гео) → Зоны (домены с редиректами).

### Примеры расчетов
- **Минимум**: 5 доменов × 1 000 посещений = 5 000 запросов/день (мало нагрузки).
- **Средний**: 10 доменов × 3 000 (активные) + 10 × 500 (неактивные) = 35 000 запросов/день.
- **Максимум**: 20 доменов × 5 000 = 100 000 запросов/день (предел Free).
- **Пессимистичный (высокий трафик)**: 10 сайтов × 4 зоны × (8 000 актив + 1 000 неактив) = 120 000 запросов/день → превышение, подключить Workers Paid ($0.015/день за 100k).

### Вывод и рекомендации
- Хватит для 95% клиентов (до 80–90k посещений/день).
- В UI платформы: «Free поддерживает до 100 000 редиректов/день. При превышении — оплата по факту ($0.015 за 100k)».
- Оптимизация: Используйте один Worker для всех доменов, минимизируйте код (редирект сразу, без лишних вычислений).

## 3. Архитектура зон и доменов

Зона в Cloudflare = контейнер для DNS-записей домена. Выбор количества зон влияет на изоляцию при блокировках, управление и лимиты правил.

### Вариант A: 1 зона (1 домен + поддомены)
- **Пример**: Зона `brand.com` с поддоменами `ru.brand.com`, `us.brand.com`.
- **Плюсы**: Дешево (1 домен), просто (один SSL, один маршрут Worker).
- **Минусы**: Нет изоляции — блокировка `brand.com` (по IP/SNI) затрагивает все поддомены. Redirect Rules: 10 на зону. Увеличивает вложенность правил Worker.
- **Когда использовать**: Low-risk гео (US, EU), где блокировки редки.

**Плюсы**
- Простота: Один домен → одна зона → один SSL-сертификат → проще в UI и API.
- Дешевизна: 1 домен, поддомены — бесплатно.
- Легко масштабировать: Добавить jp.brand-global.com — просто новая DNS-запись.

**Минусы**
- Нет изоляции при блокировке: Если brand-global.com заблокирован по IP/SNI — все поддомены недоступны , даже если трафик идёт на ru.brand-global.com.
- Один IP-адрес - (часто) Cloudflare может отдавать один и тот же IP для всех поддоменов → блокировка по IP убивает всё.
- Redirect Rules: 10 на зону. Хватит, но если делать редиректы не только по домену, а по путям — быстро закончится.


### Вариант B: N зон (N доменов 2-го уровня)
- **Пример**: `brand-ru.org` (зона 1), `brand-us.com` (зона 2).
- **Плюсы**: Изоляция при блокировке (отдельный IP/SNI). Redirect Rules: 10 на зону (итого 50+). Worker: Плоская логика (по hostname, без вложенных if).
- **Минусы**: Дороже (N доменов ~$5–15/год каждый).
- **Когда использовать**: High-risk гео (RU, EU), арбитраж с гео-сплитом.

**Плюсы** 
- Изоляция при блокировке - Если brand-ru.org заблокирован в стране — остальные домены полностью независимы (свой IP, свой SNI, своя зона).
- Гибкость DNS Можно поставить разные A-записи, разные прокси, разные TTL.
- Redirect Rules - 10 правил на каждый домен → итого 50 возможных редиректов.
- SEO / Trust Отдельные домены 2-го уровня воспринимаются как независимые проекты (лучше для некоторых ниш).

**Минусы**
- Сложность управления - Нужно покупать и продлевать 5 доменов.
- Настройка в CF - 5 зон → 5 маршрутов для Workers → больше операций через API.
- Стоимость Домены стоят денег ($5–15/год каждый).


### Гибридный подход (для разных стратегий)
- High-risk: Отдельные домены/зоны.
- Low-risk: Поддомены в одной зоне.
- В платформе: При создании сайта — выбор «Поддомен (дешевле)» или «Отдельный домен (надёжнее)».

## 4. Подходы к реализации редиректов

Редиректы (301/302) при блокировках или TDS — ключевой функционал.
Избегайте DNS-редиректов ((CNAME / A) не HTTP, вредно для SEO).
- 301 через API Cloudflare автоматически создаёт один общий редирект-Worker в аккаунте клиента (например, bulk-redirects-301).
  - Привязывает его ко всем «заблокированным» доменам через Routes (blocked1.example.com/*, geo.old.example.net/* и т.д.). 
  - Хранит маппинг «домен → целевой URL» у себя (D1/KV).
  -  Worker у клиента — очень простой, он делает fetch к вашему API или читает список из вашего KV по API.
- Использование Redirect Rules - до 10 правил на зону чтобы снизить нагрузку на Workers.

### Основной подход: Workers (бесплатно, гибко)
- **Как работает**: Один Worker привязывается к маршрутам в разных зонах (e.g., `brand-ru.org/*`, `brand-us.com/*`).
- **Автоматизация**: Платформа деплоит Worker, добавляет маршруты через API. Клиент нажимает "Заблокировать" — система обновляет конфиг.
- **Плюсы**: Нет лимитов на количество (только 100k запросов), динамическая логика (гео, EU). Гибкость - возможно управление через TDS-Worker и редирект-Worker.
- **Минусы**: Требует кода (но платформа скрывает от клиента).

#### Пример. простой редирект-Worker
```
export default {
  fetch(request) {
    return Response.redirect('https://active-brand.com', 302);
  }
}
```
#### Пример. Универсальный редирект-Worker на аккаунте клиента
```
const REDIRECTS = {
  'old1.example.com': 'https://active1.brand.com',
  'spam2.example.net': 'https://active1.brand.com',
  'geo-old.example.org': 'https://active2.brand.com',
  // ...
};
```

Альтернатива: Worker у клиента статический, а список редиректов обновляется через Wrangler API при изменении и редеплоим Worker через API, когда клиент меняет настройки.

### Дополнительный подход: Redirect Rules (бесплатно, просто) (`Rules → Rulesets → HTTP Request Rules → Manage rules → Add rule → "Redirect" action`)
- **Как работает**: Правила в Rulesets (HTTP Request Rules). Пример: `Hostname eq "old.com"` → Redirect to `new.com` (302).
- **Лимит**: 10 на зону.
- **Использование**: HTTP-редиректы (301/302) на основе: Hostname (example.com), Path (/old/*), Query, Country, Device и др.
  - Поддерживают wildcard (*), но не поддерживают регулярные выражения и подстановки (/user/123 → /profile?id=123 — нельзя).
- **Плюсы**: Без кода, через UI/API. Подходит для статических редиректов.
- **Минусы**: Нет динамики (нельзя условия по гео/EU). Создаётся в зоне источника, но редирект на любую зону/внешний домен.
  - Нельзя: `if (country == 'RU') → A, else → B` в одном правиле. Нужно 2 правила.
  - `/old/page1→/new/page1` —нельзя. Только `/old/*→/new/` (всё в один URL).
- **Когда использовать**: Как "простой режим" в UI для новичков (≤10 доменов, без логики).

#### Пример API-запроса.  Cначала надо найти или создать ruleset `http_request_redirect`.
```
POST https://api.cloudflare.com/client/v4/zones/{zone_id_A}/rulesets
{
  "name": "redirects",
  "kind": "zone",
  "phase": "http_request_redirect",
  "rules": [{
    "expression": "http.host eq \"offer.blocked.com\"",
    "action": "redirect",
    "action_parameters": {
        "status_code": 302,
        "target_url": { "value": "https://active.net/geo" }
      }
    }
  }]
}
```

> При использовани Redirect Rules в UI 301  выводится сообшение клиенту: «Осталось X из 10 редиректов для этого сайта» 

### Page Rules и Bulk Redirects (не рекомендуется)
- Page Rules: 3 на аккаунт (Free) — слишком мало.
- Bulk Redirects: Только Business+ — избыточно.

## 5. Модель TDS ("набор с правилами")

TDS — распределение трафика по правилам. Реализуйте через Workers (динамика). Правила: Условия + Действие, обрабатываются сверху вниз (первое совпадение — выполняется).

### Базовые условия (на Free)
- Гео: `request.cf.country` (~250 стран, e.g., "RU").
- User-Agent: `request.headers.get('User-Agent')` — для устройства (mobile/desktop), OS, браузера (парсинг, e.g., `/Mobile/i.test(ua)`).
- Боты/Поисковики: По User-Agent (e.g., `Googlebot`, `YandexBot`). Нет готового флага от CF — проверяйте ключевые строки.
- Другие: IP (`CF-Connecting-IP`), путь, параметры URL, hostname.

### Пример структуры TDS-набора
- Правило 1: Гео = RU, Device = Mobile → Redirect to лендинг A.
- Правило 2: Гео = RU → Софт-блок.
- Правило 3: Default → Универсальный редирект.
- Максимум правил: Технически неограничено, практично 5–10 на один набор.

### Бизнес-модель для платформы
**Free**: 
- 1 Проект
- 10 Сайтов (это 10 зон или 10 доменов 2го уровня)
  - Количество субдоменов не ограничено (регулируется UI)
- 1 набор (шаблон с 50 базовыми правилами: гео, RU, device).
**Paid**: 
- Множество проектов (прокет может быть привязан к одному аккаунту CF пользователя)
  - Количество аккаунтов пользователя в CF (ключей доступа к CF - 10)
- Множество сайтов. 
  - Допустимо создание нескольких сайтов (зон CF) и распределение их по разным проектам.
- Множество наборов, привязка к доменам, A/B-тесты, кастомные цепочки.

Реализация: Worker загружает конфиг из api.310.st по hostname. Клиент редактирует в UI — платформа обновляет данные, не код.

## 6. Summary платформы (301)
- «Не нужен платный Cloudflare — всё на Free Workers».
- **API-права клиента**: Zone: Read; Worker Scripts: Edit; Account: Read.
- **Шаблоны**: Редиректы/TDS на вашей стороне, применяйте через API.
- **Мониторинг**: Через Wrangler tail или логи в вашу систему.
- **Гибкость**: Гибрид Workers + Redirect Rules для простых клиентов.

## Заключение
- 301 - модель позволяет клиентам работать на бесплатном Cloudflare, минимизируя затраты и сложность.
- Основной фокус — Workers для динамики, с Redirect Rules как опцией.
- При росте нагрузки — клиент подключает Workers Paid.
- Для high-risk сценариев используйте несколько зон. Это обеспечит масштабируемость и удобство без избыточных предложений от Cloudflare.


